<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Australian Business Development & CRM System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        :root {
            --qld-maroon: #771414;
            --qld-gold: #FFCD00;
            --nsw-blue: #00247D;
            --vic-navy: #000080;
            --sa-red: #D40000;
            --wa-gold: #FFD700;
            --tas-green: #006747;
            --nt-orange: #E65C00;
            --act-blue: #0055A4;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f0;
            background-image: radial-gradient(at 0% 0%, rgba(119, 20, 20, 0.03) 0px, transparent 50%);
        }

        h1, h2, h3, .display-font {
            font-family: 'Space Grotesk', sans-serif;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .region-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            border-left: 4px solid var(--qld-maroon);
        }

        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .sync-indicator {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        .priority-high { border-left-color: #dc2626; }
        .priority-medium { border-left-color: #f59e0b; }
        .priority-low { border-left-color: #10b981; }

        .offline-banner {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            color: white;
            transform: translateY(-100%);
            transition: transform 0.3s;
        }

        .offline-banner.show {
            transform: translateY(0);
        }

        .region-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .region-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .region-scroll::-webkit-scrollbar-thumb {
            background: #771414;
            border-radius: 3px;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .toast {
            transform: translateX(120%);
            transition: transform 0.3s ease-out;
        }

        .toast.show {
            transform: translateX(0);
        }

        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--qld-maroon), var(--qld-gold));
        }

        .region-group {
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
            border: 1px solid #e5e7eb;
        }

        .demo-badge {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
        }

        .main-tab {
            position: relative;
            transition: all 0.3s;
        }

        .main-tab.active {
            color: #771414;
            font-weight: 600;
        }

        .main-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: #771414;
            border-radius: 3px 3px 0 0;
        }

        .status-to-price { background: #dbeafe; color: #1e40af; }
        .status-priced { background: #dcfce7; color: #166534; }
        .status-not-pricing { background: #f3f4f6; color: #6b7280; }

        .crm-contact-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 4px solid #3b82f6;
        }

        .crm-contact-card.category-council { border-left-color: #3b82f6; }
        .crm-contact-card.category-supplier { border-left-color: #10b981; }
        .crm-contact-card.category-contractor { border-left-color: #f59e0b; }
        .crm-contact-card.category-competitor { border-left-color: #ef4444; }

        .interaction-timeline {
            position: relative;
            padding-left: 20px;
        }

        .interaction-timeline::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }

        .timeline-dot {
            position: absolute;
            left: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #3b82f6;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #e5e7eb;
        }

        .not-won-card {
            background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
            border-left: 4px solid #ef4444;
        }

        .category-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .category-council { background: #dbeafe; color: #1e40af; }
        .category-supplier { background: #d1fae5; color: #065f46; }
        .category-contractor { background: #fef3c7; color: #92400e; }
        .category-competitor { background: #fee2e2; color: #991b1b; }

        .zone-filter[data-zone="SEQ"].active { background-color: #771414 !important; color: white !important; }
        .zone-filter[data-zone="NQ"].active { background-color: #0369a1 !important; color: white !important; }
        .zone-filter[data-zone="CQ"].active { background-color: #059669 !important; color: white !important; }
        .zone-filter[data-zone="SWQ"].active { background-color: #d97706 !important; color: white !important; }
        .zone-filter[data-zone="FNQ"].active { background-color: #10b981 !important; color: white !important; }
        .zone-filter[data-zone="GULF"].active { background-color: #8b5cf6 !important; color: white !important; }

        /* State Selector Styles */
        .state-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .state-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        .state-card.qld { border-top: 4px solid #771414; }
        .state-card.nsw { border-top: 4px solid #00247D; }
        .state-card.vic { border-top: 4px solid #000080; }
        .state-card.sa { border-top: 4px solid #D40000; }
        .state-card.wa { border-top: 4px solid #FFD700; }
        .state-card.tas { border-top: 4px solid #006747; }
        .state-card.nt { border-top: 4px solid #E65C00; }
        .state-card.act { border-top: 4px solid #0055A4; }

        /* Watermark Styles */
        .watermark-container {
            position: relative;
        }
        .watermark-initials {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .watermark-tooltip {
            position: absolute;
            top: 45px;
            right: 0;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
            z-index: 20;
        }
        .watermark-container:hover .watermark-tooltip {
            opacity: 1;
            visibility: visible;
        }

        /* State Dropdown */
        .state-dropdown {
            position: relative;
        }
        .state-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 220px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
        }
        .state-dropdown:hover .state-dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .state-dropdown-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .state-dropdown-item:hover {
            background: #f3f4f6;
        }
        .state-dropdown-item:first-child {
            border-radius: 12px 12px 0 0;
        }
        .state-dropdown-item:last-child {
            border-radius: 0 0 12px 12px;
        }
        .state-flag {
            width: 28px;
            height: 20px;
            border-radius: 3px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
        }
    </style>
</head>
<body class="text-gray-800 min-h-screen">

    <!-- Offline Warning -->
    <div id="offlineBanner" class="offline-banner fixed top-0 left-0 right-0 z-50 px-4 py-2 text-center text-sm font-medium">
        <i class="fas fa-wifi-slash mr-2"></i> You're offline. Changes will sync when you reconnect.
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-800 rounded-full flex items-center justify-center text-white text-2xl mx-auto mb-4">
                    <i class="fas fa-building"></i>
                </div>
                <h2 class="text-2xl font-bold display-font">Australian Business Development & CRM</h2>
                <p class="text-gray-500 mt-2">All States & Territories</p>
            </div>

            <div id="authForm">
                <div class="mb-3">
                    <label for="authEmail" class="block text-sm font-medium text-gray-700 mb-1">Email address</label>
                    <input type="email" 
                           id="authEmail" 
                           name="email"
                           autocomplete="email" 
                           placeholder="your@email.com" 
                           class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                </div>
                
                <div class="mb-4">
                    <label for="authPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" 
                           id="authPassword" 
                           name="password"
                           autocomplete="current-password" 
                           placeholder="••••••••" 
                           class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                </div>

                <button type="button" onclick="signIn()" class="w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-colors mb-3">
                    Sign In
                </button>

                <div class="relative mb-4">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">or</span>
                    </div>
                </div>

                <button onclick="enterDemoMode()" class="w-full py-3 bg-gray-800 text-white rounded-lg font-medium hover:bg-gray-900 transition-colors flex items-center justify-center">
                    <i class="fas fa-play-circle mr-2"></i> Continue in Demo Mode
                </button>

                <p class="text-xs text-center text-gray-400 mt-4">
                    Demo mode stores data locally on your device. No account required.
                </p>
            </div>
        </div>
    </div>

    <!-- State Selector Modal -->
    <div id="stateSelectorModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl max-w-5xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
                <div>
                    <h3 class="text-2xl font-bold display-font">Select State or Territory</h3>
                    <p class="text-gray-500 text-sm mt-1">Choose your region to access relevant LGAs and data</p>
                </div>
            </div>

            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="stateSelectorGrid">
                    <!-- States will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden until auth or demo) -->
    <div id="mainApp" class="hidden">

        <!-- Navigation -->
        <nav class="glass-panel sticky top-0 z-40 border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center space-x-4">
                        <!-- State Switcher Dropdown -->
                        <div class="state-dropdown">
                            <button id="currentStateButton" class="flex items-center space-x-2 px-3 py-2 rounded-lg hover:bg-gray-100 transition-colors">
                                <div id="currentStateFlag" class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-lg">
                                    QLD
                                </div>
                                <div class="text-left">
                                    <h1 class="text-lg font-bold text-gray-900 display-font tracking-tight" id="currentStateName">Queensland</h1>
                                    <div class="flex items-center text-xs text-gray-500">
                                        <span id="userEmail"></span>
                                        <span id="demoBadge" class="hidden demo-badge ml-2">DEMO MODE</span>
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down text-gray-400 ml-2"></i>
                            </button>
                            
                            <div class="state-dropdown-menu">
                                <div class="px-4 py-2 text-xs font-semibold text-gray-500 border-b">Switch State/Territory</div>
                                <div id="stateDropdownItems">
                                    <!-- State items populated by JS -->
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center space-x-2 text-xs text-gray-500">
                            <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                            <span id="syncStatus" class="flex items-center text-green-600">
                                <i class="fas fa-check-circle mr-1"></i> Ready
                            </span>
                            <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                            <span class="text-gray-700 font-semibold" id="lgaCount">77 LGAs</span>
                        </div>
                    </div>

                    <div class="flex items-center space-x-4">
                        <button id="adminButton" onclick="showAdminPanel()" class="hidden px-4 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 text-sm font-medium transition-colors shadow-sm">
                            <i class="fas fa-shield-alt mr-2"></i> Admin
                        </button>

                        <button onclick="exportToExcel()" class="hidden md:flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors shadow-sm">
                            <i class="fas fa-file-excel mr-2"></i> Export Excel
                        </button>

                        <button onclick="shareReport()" class="hidden md:flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors shadow-sm">
                            <i class="fas fa-share-alt mr-2"></i> Share
                        </button>

                        <button onclick="signOut()" class="px-4 py-2 text-gray-600 hover:text-gray-900 text-sm font-medium">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>

                        <div class="relative">
                            <input type="text" id="globalSearch" placeholder="Search LGAs..." 
                                   class="pl-10 pr-4 py-2 rounded-full bg-gray-100 border-none focus:ring-2 focus:ring-blue-600 w-56 text-sm"
                                   onkeyup="globalSearch()">
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Navigation Tabs -->
        <div class="bg-white border-b border-gray-200 sticky top-16 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="switchMainTab('tenders')" id="tab-tenders" class="main-tab active py-4 px-2 text-sm font-medium text-gray-600 hover:text-gray-900 flex items-center">
                        <i class="fas fa-file-contract mr-2 text-blue-600"></i> Tenders & Opportunities
                    </button>
                    <button onclick="switchMainTab('crm')" id="tab-crm" class="main-tab py-4 px-2 text-sm font-medium text-gray-600 hover:text-gray-900 flex items-center">
                        <i class="fas fa-users mr-2 text-green-600"></i> CRM & Contacts
                    </button>
                    <button onclick="switchMainTab('analytics')" id="tab-analytics" class="main-tab py-4 px-2 text-sm font-medium text-gray-600 hover:text-gray-900 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-purple-600"></i> Analytics & Pipeline
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

            <!-- TENDERS TAB CONTENT -->
            <div id="content-tenders" class="main-content">

                <!-- Dashboard Stats -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                    <div class="stat-card rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">To Price</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="statToPrice">-</h3>
                            </div>
                            <div class="p-2 bg-blue-50 rounded-lg">
                                <i class="fas fa-calculator text-blue-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">Priced</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="statPriced">-</h3>
                            </div>
                            <div class="p-2 bg-green-50 rounded-lg">
                                <i class="fas fa-check-circle text-green-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">Not Pricing</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="statNotPricing">-</h3>
                            </div>
                            <div class="p-2 bg-gray-50 rounded-lg">
                                <i class="fas fa-ban text-gray-600"></i>
                            </div>
                        </div>
                    </div>

                    <div class="stat-card rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">Awarded</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="statAwarded">-</h3>
                            </div>
                            <div class="p-2 bg-yellow-50 rounded-lg">
                                <i class="fas fa-trophy text-yellow-600"></i>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Total: <span id="statTotalValue">-</span></p>
                    </div>

                    <div class="stat-card rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">Not Won</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="statNotWon">-</h3>
                            </div>
                            <div class="p-2 bg-red-50 rounded-lg">
                                <i class="fas fa-times-circle text-red-600"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Region Selector -->
                <div class="mb-8">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold display-font text-gray-900">Select Region</h2>
                            <p class="text-sm text-gray-500 mt-1" id="regionSubtitle">Browse by zone or search all LGAs</p>
                        </div>

                        <div class="flex flex-wrap gap-2" id="zoneFilters">
                            <!-- Zone filters populated by JS -->
                        </div>
                    </div>

                    <div class="region-group rounded-xl p-4 mb-6">
                        <div class="flex space-x-2 overflow-x-auto pb-2 region-scroll" id="regionTabs" style="max-height: 200px; flex-wrap: wrap;">
                        </div>
                    </div>

                    <div id="regionContent" class="space-y-6">
                        <div class="flex items-center justify-center h-64">
                            <div class="loading-skeleton w-full h-full rounded-xl"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM TAB CONTENT -->
            <div id="content-crm" class="main-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold display-font text-gray-900 mb-2">Customer Relationship Management</h2>
                    <p class="text-gray-600">Manage all your council contacts, suppliers, contractors, and competitors across all LGAs.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                    <div class="bg-blue-50 rounded-xl p-5 border border-blue-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-blue-600 font-medium">Total Contacts</p>
                                <h3 class="text-3xl font-bold text-blue-900" id="crmTotalContacts">-</h3>
                            </div>
                            <i class="fas fa-address-book text-blue-400 text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-blue-50 rounded-xl p-5 border border-blue-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-blue-600 font-medium">Councils</p>
                                <h3 class="text-2xl font-bold text-blue-900" id="crmCouncils">-</h3>
                            </div>
                            <i class="fas fa-landmark text-blue-400 text-xl"></i>
                        </div>
                    </div>
                    <div class="bg-green-50 rounded-xl p-5 border border-green-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-green-600 font-medium">Suppliers</p>
                                <h3 class="text-2xl font-bold text-green-900" id="crmSuppliers">-</h3>
                            </div>
                            <i class="fas fa-truck text-green-400 text-xl"></i>
                        </div>
                    </div>
                    <div class="bg-orange-50 rounded-xl p-5 border border-orange-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-orange-600 font-medium">Contractors</p>
                                <h3 class="text-2xl font-bold text-orange-900" id="crmContractors">-</h3>
                            </div>
                            <i class="fas fa-hard-hat text-orange-400 text-xl"></i>
                        </div>
                    </div>
                    <div class="bg-red-50 rounded-xl p-5 border border-red-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-red-600 font-medium">Competitors</p>
                                <h3 class="text-2xl font-bold text-red-900" id="crmCompetitors">-</h3>
                            </div>
                            <i class="fas fa-chess text-red-400 text-xl"></i>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <div class="flex-1">
                        <input type="text" id="crmSearch" placeholder="Search contacts by name, position, or organization..." 
                               class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                               onkeyup="searchCRM()">
                    </div>
                    <select id="crmCategoryFilter" onchange="filterCRM()" class="px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                        <option value="all">All Categories</option>
                        <option value="Council">Council</option>
                        <option value="Supplier">Supplier</option>
                        <option value="Contractor">Contractor</option>
                        <option value="Competitor">Competitor</option>
                    </select>
                    <select id="crmRegionFilter" onchange="filterCRM()" class="px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                        <option value="all">All Regions</option>
                    </select>
                    <button onclick="showAddCRMModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium whitespace-nowrap">
                        <i class="fas fa-plus mr-2"></i> Add Contact
                    </button>
                </div>

                <div id="crmContactsList" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                </div>
            </div>

            <!-- ANALYTICS TAB CONTENT -->
            <div id="content-analytics" class="main-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold display-font text-gray-900 mb-2">Analytics & Pipeline</h2>
                    <p class="text-gray-600">Track your win rates, pricing performance, and pipeline value across all regions.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                        <h3 class="text-lg font-bold mb-4">Win Rate Analysis</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-600">Total Tenders Priced</span>
                                <span class="font-bold text-xl" id="analyticsTotalPriced">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                <span class="text-green-700">Won</span>
                                <span class="font-bold text-xl text-green-700" id="analyticsWon">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                <span class="text-red-700">Lost</span>
                                <span class="font-bold text-xl text-red-700" id="analyticsLost">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                <span class="text-blue-700">Win Rate</span>
                                <span class="font-bold text-xl text-blue-700" id="analyticsWinRate">0%</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                        <h3 class="text-lg font-bold mb-4">Pipeline Value</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                <span class="text-blue-700">To Price</span>
                                <span class="font-bold text-xl text-blue-700" id="analyticsToPriceValue">$0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                <span class="text-green-700">Priced & Submitted</span>
                                <span class="font-bold text-xl text-green-700" id="analyticsPricedValue">$0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                                <span class="text-yellow-700">Awarded Value</span>
                                <span class="font-bold text-xl text-yellow-700" id="analyticsAwardedValue">$0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                                <span class="text-purple-700">Total Pipeline</span>
                                <span class="font-bold text-xl text-purple-700" id="analyticsTotalPipeline">$0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <h3 class="text-lg font-bold mb-4">Performance by Region</h3>
                    <div id="regionPerformanceList" class="space-y-3">
                    </div>
                </div>
            </div>

        </div>

        <!-- Tender Entry Modal -->
        <div id="tenderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
                    <h3 class="text-xl font-bold display-font" id="tenderModalTitle">Add New Tender</h3>
                    <button onclick="closeTenderModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="tenderForm" class="p-6 space-y-4" onsubmit="saveTender(event)">
                    <input type="hidden" id="tenderId">
                    <input type="hidden" id="tenderRegion">

                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Project Title *</label>
                            <input type="text" id="tenderTitle" required class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="tenderCategory" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none bg-white">
                                <option value="Infrastructure">Infrastructure</option>
                                <option value="Construction">Construction</option>
                                <option value="Professional Services">Professional Services</option>
                                <option value="IT & Digital">IT & Digital</option>
                                <option value="Environmental">Environmental</option>
                                <option value="Community Services">Community Services</option>
                                <option value="Waste Management">Waste Management</option>
                                <option value="Water & Sewerage">Water & Sewerage</option>
                                <option value="Roads & Transport">Roads & Transport</option>
                                <option value="Parks & Recreation">Parks & Recreation</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                            <select id="tenderStatus" required onchange="togglePricingFields()" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none bg-white">
                                <option value="TO_PRICE">TO PRICE</option>
                                <option value="PRICED">PRICED</option>
                                <option value="NOT_PRICING">NOT PRICING</option>
                                <option value="AWARDED">AWARDED</option>
                                <option value="NOT_WON">NOT WON</option>
                            </select>
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Estimated Value ($)</label>
                            <input type="text" id="tenderValue" placeholder="$0.00" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Closing Date</label>
                            <input type="date" id="tenderClosingDate" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                        </div>

                        <div id="pricedFields" class="col-span-2 hidden border-t pt-4 mt-2">
                            <h4 class="font-semibold text-green-700 mb-3 flex items-center">
                                <i class="fas fa-check-circle mr-2"></i> Pricing Details
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Our Price ($)</label>
                                    <input type="text" id="ourPrice" placeholder="$0.00" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Submission Date</label>
                                    <input type="date" id="submissionDate" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                                </div>
                            </div>
                        </div>

                        <div id="notPricingFields" class="col-span-2 hidden border-t pt-4 mt-2">
                            <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                                <i class="fas fa-ban mr-2"></i> Reason for Not Pricing
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
                                    <select id="notPricingReason" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none bg-white">
                                        <option value="">Select reason...</option>
                                        <option value="Capacity">At Capacity</option>
                                        <option value="Capability">Outside Capability</option>
                                        <option value="Location">Too Remote</option>
                                        <option value="Value">Too Small/Large</option>
                                        <option value="Conflict">Conflict of Interest</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Comments</label>
                                    <textarea id="notPricingComments" rows="2" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none"></textarea>
                                </div>
                            </div>
                        </div>

                        <div id="awardedFields" class="col-span-2 hidden border-t pt-4 mt-2">
                            <h4 class="font-semibold text-yellow-700 mb-3 flex items-center">
                                <i class="fas fa-trophy mr-2"></i> Award Details
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Awarded Date</label>
                                    <input type="date" id="awardedDate" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Contract Value ($)</label>
                                    <input type="text" id="awardedValue" placeholder="$0.00" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Scope Summary</label>
                                    <textarea id="awardedScope" rows="2" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none"></textarea>
                                </div>
                            </div>
                        </div>

                        <div id="notWonFields" class="col-span-2 hidden border-t pt-4 mt-2">
                            <h4 class="font-semibold text-red-700 mb-3 flex items-center">
                                <i class="fas fa-times-circle mr-2"></i> Competitor Information
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Who Won?</label>
                                    <input type="text" id="winnerName" placeholder="Company name" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Their Price ($) (if known)</label>
                                    <input type="text" id="winnerPrice" placeholder="$0.00" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Our Price ($)</label>
                                    <input type="text" id="ourLosingPrice" placeholder="$0.00" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Announced</label>
                                    <input type="date" id="resultDate" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Comments / Lessons Learned</label>
                                    <textarea id="notWonComments" rows="3" placeholder="Why did we lose? What could we do better next time?" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="col-span-2 border-t pt-4 mt-2">
                            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-user-tie mr-2 text-blue-600"></i> Council Contact Details
                            </h4>
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Name</label>
                            <input type="text" id="tenderContactName" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
                            <input type="text" id="tenderContactPosition" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="tenderContactEmail" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                            <input type="tel" id="tenderContactPhone" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none">
                        </div>

                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Project Description</label>
                            <textarea id="tenderDescription" rows="3" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-600 focus:outline-none"></textarea>
                        </div>
                        
                        <div class="col-span-2 border-t pt-4 mt-2">
                            <h4 class="font-semibold text-purple-900 mb-3 flex items-center">
                                <i class="fas fa-comments mr-2 text-purple-600"></i> Comments & History
                            </h4>
                            
                            <div id="tenderCommentsList" class="space-y-2 mb-4 max-h-40 overflow-y-auto">
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Add Update/Comment</label>
                                <textarea id="newTenderComment" rows="2" placeholder="Enter update or comment..." class="w-full rounded-lg px-3 py-2 border-2 border-gray-200 focus:border-purple-500 focus:outline-none text-sm mb-2"></textarea>
                                <button type="button" onclick="addTenderComment()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium">
                                    <i class="fas fa-plus mr-1"></i> Add Comment
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeTenderModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-lg">
                            <i class="fas fa-save mr-2"></i> Save Tender
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- CRM Contact Modal -->
        <div id="crmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
                    <h3 class="text-xl font-bold display-font" id="crmModalTitle">Add CRM Contact</h3>
                    <button onclick="closeCRMModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="crmForm" class="p-6 space-y-4" onsubmit="saveCRM(event)">
                    <input type="hidden" id="crmContactId">

                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category *</label>
                            <select id="crmCategory" required onchange="handleCategoryChange()" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                                <option value="Council">Council (LGA)</option>
                                <option value="Supplier">Supplier</option>
                                <option value="Contractor">Contractor</option>
                                <option value="Competitor">Competitor</option>
                            </select>
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Region</label>
                            <select id="crmRegion" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                                <option value="">Select Region...</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-1" id="regionHelp">Required for Council contacts</p>
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Type</label>
                            <select id="crmType" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                                <option value="Procurement">Procurement</option>
                                <option value="Engineering">Engineering</option>
                                <option value="Management">Management</option>
                                <option value="Elected">Elected Member</option>
                                <option value="Operations">Operations</option>
                                <option value="Sales">Sales</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                            <input type="text" id="crmName" required class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Position/Title *</label>
                            <input type="text" id="crmPosition" required class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Organization/Company</label>
                            <input type="text" id="crmDepartment" placeholder="e.g., Brisbane City Council, Acme Supplies Pty Ltd" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Direct Phone</label>
                            <input type="tel" id="crmDirectPhone" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
                            <input type="tel" id="crmMobile" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>

                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                            <input type="email" id="crmEmail" required class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>

                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">LinkedIn Profile</label>
                            <input type="url" id="crmLinkedIn" placeholder="https://linkedin.com/in/..." class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>

                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Relationship Notes</label>
                            <textarea id="crmNotes" rows="3" placeholder="How did you meet? Interests, family, preferences..." class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none"></textarea>
                        </div>

                        <div class="col-span-2 border-t pt-4 mt-2">
                            <h4 class="font-semibold text-blue-900 mb-3 flex items-center">
                                <i class="fas fa-clock mr-2"></i> Last Interaction
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                    <input type="date" id="crmLastContactDate" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                    <select id="crmLastContactType" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                                        <option value="">Select...</option>
                                        <option value="Meeting">Meeting</option>
                                        <option value="Phone">Phone Call</option>
                                        <option value="Email">Email</option>
                                        <option value="Event">Industry Event</option>
                                        <option value="Tender">Tender Discussion</option>
                                    </select>
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes from Last Contact</label>
                                    <textarea id="crmLastContactNotes" rows="2" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="col-span-2 border-t pt-4 mt-2">
                            <h4 class="font-semibold text-orange-900 mb-3 flex items-center">
                                <i class="fas fa-bell mr-2"></i> Follow-up Reminder
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Next Follow-up Date</label>
                                    <input type="date" id="crmFollowUpDate" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                    <select id="crmPriority" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                                        <option value="High">High</option>
                                        <option value="Medium" selected>Medium</option>
                                        <option value="Low">Low</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeCRMModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-lg">
                            <i class="fas fa-save mr-2"></i> Save Contact
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Interaction Modal -->
        <div id="interactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl max-w-lg w-full shadow-2xl">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
                    <h3 class="text-xl font-bold display-font">Add Interaction</h3>
                    <button onclick="closeInteractionModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="interactionForm" class="p-6 space-y-4" onsubmit="saveInteraction(event)">
                    <input type="hidden" id="interactionContactId">

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                        <input type="date" id="interactionDate" required class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                        <select id="interactionType" required class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                            <option value="Meeting">Meeting</option>
                            <option value="Phone">Phone Call</option>
                            <option value="Email">Email</option>
                            <option value="Video">Video Call</option>
                            <option value="Event">Industry Event</option>
                            <option value="Site Visit">Site Visit</option>
                            <option value="Tender Discussion">Tender Discussion</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes *</label>
                        <textarea id="interactionNotes" required rows="4" placeholder="What was discussed? Any action items?" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Next Steps</label>
                        <input type="text" id="interactionNextSteps" placeholder="Any follow-up required?" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                    </div>

                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeInteractionModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-lg">
                            <i class="fas fa-plus mr-2"></i> Add Interaction
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Admin Panel Modal -->
        <div id="adminPanel" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
                    <h3 class="text-xl font-bold display-font flex items-center">
                        <i class="fas fa-shield-alt mr-2 text-gray-800"></i> Admin Panel
                    </h3>
                    <button onclick="closeAdminPanel()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="p-6">
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-900 mb-2">User Management</h4>
                        <p class="text-sm text-gray-500">Manage approved users</p>
                    </div>

                    <div id="approvedUsersList" class="space-y-2">
                        <div class="text-center py-4 text-gray-400">
                            <p>Loading users...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

        <!-- Quick Actions -->
        <div class="fixed bottom-8 right-8 flex flex-col space-y-3">
            <button onclick="quickAdd()" class="w-14 h-14 bg-blue-600 text-white rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all flex items-center justify-center group relative">
                <i class="fas fa-plus text-xl"></i>
                <span class="absolute right-16 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Quick Add</span>
            </button>
        </div>
    </div>

<script>
    } else {
        navigator.clipboard.writeText(window.location.href);
        showToast('Link copied to clipboard!', 'success');
    }
}

function quickAdd() {
    if (currentMainTab === 'tenders') {
        showAddTenderModal();
    } else if (currentMainTab === 'crm') {
        showAddCRMModal();
    } else if (currentMainTab === 'analytics') {
        switchMainTab('tenders');
        setTimeout(() => showAddTenderModal(), 100);
    }
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');

    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-blue-500',
        warning: 'bg-amber-500'
    };

    toast.className = `toast ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2`;
    toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
        <span>${message}</span>
    `;

    container.appendChild(toast);

    setTimeout(() => toast.classList.add('show'), 100);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ==================== ADMIN FUNCTIONS ====================

async function showAdminPanel() {
    console.log("Admin panel requested");
    
    try {
        const isAdmin = await checkIfAdmin();
        console.log("Is admin:", isAdmin);
        
        if (!isAdmin) {
            showToast('Access denied. Admin only.', 'error');
            return;
        }

        document.getElementById('adminPanel').classList.remove('hidden');
        await loadApprovedUsers();
        
    } catch (error) {
        console.error("Error opening admin panel:", error);
        showToast('Error opening admin panel: ' + error.message, 'error');
    }
}

function closeAdminPanel() {
    document.getElementById('adminPanel').classList.add('hidden');
}

async function loadApprovedUsers() {
    try {
        const snapshot = await db.collection('approvedUsers')
            .where('approved', '==', true)
            .orderBy('approvedAt', 'desc')
            .get();

        const container = document.getElementById('approvedUsersList');

        if (snapshot.empty) {
            container.innerHTML = '<p class="text-gray-400 text-center py-4">No approved users yet</p>';
            return;
        }

        container.innerHTML = snapshot.docs.map(doc => {
            const data = doc.data();
            const date = data.approvedAt ? new Date(data.approvedAt).toLocaleDateString('en-AU') : 'Unknown';
            return `
            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-100">
                <div>
                    <div class="font-medium text-gray-900">${data.email}</div>
                    <div class="text-xs text-green-700">Approved: ${date}</div>
                </div>
                <button onclick="revokeAccess('${doc.id}')" class="text-red-600 hover:text-red-800 text-sm">
                    <i class="fas fa-user-times"></i> Revoke
                </button>
            </div>
            `;
        }).join('');

    } catch (err) {
        console.error("Error loading approved users:", err);
        document.getElementById('approvedUsersList').innerHTML = `
            <p class="text-red-400 text-center py-4">Error loading users: ${err.message}</p>
        `;
    }
}

async function revokeAccess(uid) {
    if (!confirm('Are you sure you want to revoke this user\'s access?')) {
        return;
    }

    try {
        await db.collection('approvedUsers').doc(uid).update({
            approved: false,
            revokedAt: new Date().toISOString(),
            revokedBy: currentUser.email
        });

        showToast('Access revoked', 'success');
        await loadApprovedUsers();

    } catch (err) {
        showToast('Error revoking access: ' + err.message, 'error');
    }
}

// ==================== INITIALIZATION ====================

document.addEventListener('DOMContentLoaded', function() {
    // Close modals on outside click
    window.onclick = function(event) {
        const modals = ['tenderModal', 'crmModal', 'interactionModal', 'adminPanel'];
        modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (event.target === modal) {
                modal.classList.add('hidden');
            }
        });
    };
});
</script>
</body>
</html>
