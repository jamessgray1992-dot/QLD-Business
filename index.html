<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QLD Business Development & CRM System - All 77 LGAs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyACeeQF5c4sKwQxM4LaW4pzlPd7R5HuRSg",
            authDomain: "queensland-business-reporting.firebaseapp.com",
            projectId: "queensland-business-reporting",
            storageBucket: "queensland-business-reporting.firebasestorage.app",
            messagingSenderId: "271437640355",
            appId: "1:271437640355:web:d11f19e2b61c30d5bd8516",
            measurementId: "G-XE0LCMYLC5"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(console.error);
        
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('userEmail').textContent = user.email;
                checkUserApproval(user);
            } else {
                document.getElementById('authModal').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('hidden');
            }
        });
    </script>

    <style>
        :root { --qld-maroon: #771414; --qld-gold: #FFCD00; }
        body { font-family: 'Inter', sans-serif; background-color: #f5f5f0; }
        h1, h2, h3, .display-font { font-family: 'Space Grotesk', sans-serif; }
        .glass-panel { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1); }
        .region-card { border-left: 4px solid var(--qld-maroon); background: white; }
        .main-tab.active { color: var(--qld-maroon); font-weight: 600; border-bottom: 3px solid var(--qld-maroon); }
        .offline-banner { background: #f59e0b; color: white; transform: translateY(-100%); transition: transform 0.3s; }
        .offline-banner.show { transform: translateY(0); }
        .toast { transform: translateX(120%); transition: transform 0.3s; }
        .toast.show { transform: translateX(0); }
        .category-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
        .category-council { background: #dbeafe; color: #1e40af; }
        .category-supplier { background: #d1fae5; color: #065f46; }
        .category-contractor { background: #fef3c7; color: #92400e; }
        .category-competitor { background: #fee2e2; color: #991b1b; }
    </style>
</head>

<body class="text-gray-800 min-h-screen">
    <div id="offlineBanner" class="offline-banner fixed top-0 left-0 right-0 z-50 px-4 py-2 text-center text-sm font-medium">
        <i class="fas fa-wifi-slash mr-2"></i> Syncing issues detected. Check your connection.
    </div>

    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-[#771414] to-[#9f1c1c] rounded-full flex items-center justify-center text-white text-2xl mx-auto mb-4">
                    <i class="fas fa-building"></i>
                </div>
                <h2 class="text-2xl font-bold display-font">QLD Pipeline and CRM</h2>
            </div>
            <div class="space-y-4">
                <input type="email" id="authEmail" placeholder="Email" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200">
                <input type="password" id="authPassword" placeholder="Password" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200">
                <button onclick="signIn()" class="w-full py-3 bg-[#771414] text-white rounded-lg font-medium">Sign In</button>
                <button onclick="signUp()" class="w-full py-3 border-2 border-[#771414] text-[#771414] rounded-lg">Create Account</button>
                <button onclick="enterDemoMode()" class="w-full py-3 bg-gray-800 text-white rounded-lg">Demo Mode</button>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <nav class="glass-panel sticky top-0 z-40 border-b border-gray-200 bg-white">
            <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-[#771414] rounded-lg flex items-center justify-center text-white font-bold">QLD</div>
                    <div>
                        <h1 class="text-lg font-bold">Business Development & CRM</h1>
                        <p class="text-xs text-gray-500"><span id="userEmail"></span> | <span id="syncStatus">Ready</span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="adminButton" onclick="showAdminPanel()" class="hidden px-4 py-2 bg-gray-800 text-white rounded-lg text-sm">Admin</button>
                    <button onclick="signOut()" class="text-gray-500"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </nav>

        <div class="bg-white border-b sticky top-16 z-30">
            <div class="max-w-7xl mx-auto px-4 flex space-x-8">
                <button onclick="switchMainTab('tenders')" id="tab-tenders" class="main-tab active py-4 text-sm font-medium">Tenders</button>
                <button onclick="switchMainTab('crm')" id="tab-crm" class="main-tab py-4 text-sm font-medium">CRM</button>
                <button onclick="switchMainTab('analytics')" id="tab-analytics" class="main-tab py-4 text-sm font-medium">Analytics</button>
            </div>
        </div>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <div id="content-tenders" class="main-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Tenders & Opportunities</h2>
                    <div class="flex gap-2" id="zoneFilters">
                        </div>
                </div>
                <div id="regionTabs" class="flex gap-2 overflow-x-auto mb-6 pb-2"></div>
                <div id="regionContent" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="content-crm" class="main-content hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">CRM & Contacts</h2>
                    <button onclick="showAddCRMModal()" class="px-6 py-2 bg-blue-600 text-white rounded-lg">Add Contact</button>
                </div>
                <div id="crmContactsList" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
            </div>

            <div id="content-analytics" class="main-content hidden">
                <div id="analyticsDisplay" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
            </div>
        </main>
    </div>

    <div id="crmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-lg w-full p-6">
            <h3 class="text-xl font-bold mb-4" id="crmModalTitle">Add Contact</h3>
            <form id="crmForm" onsubmit="saveCRM(event)" class="space-y-4">
                <input type="hidden" id="crmContactId">
                <select id="crmCategory" class="w-full p-2 border rounded" required>
                    <option value="Council">Council</option>
                    <option value="Supplier">Supplier</option>
                    <option value="Contractor">Contractor</option>
                    <option value="Competitor">Competitor</option>
                </select>
                <input type="text" id="crmName" placeholder="Name" class="w-full p-2 border rounded" required>
                <input type="text" id="crmPosition" placeholder="Position" class="w-full p-2 border rounded">
                <input type="email" id="crmEmail" placeholder="Email" class="w-full p-2 border rounded">
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeCRMModal()" class="px-4 py-2 border rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="tenderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl max-w-lg w-full p-6">
            <h3 class="text-xl font-bold mb-4" id="tenderModalTitle">Tender Details</h3>
            <form id="tenderForm" onsubmit="saveTender(event)" class="space-y-4">
                <input type="hidden" id="tenderId">
                <input type="hidden" id="tenderRegion">
                <input type="text" id="tenderTitle" placeholder="Project Title" class="w-full p-2 border rounded" required>
                <select id="tenderStatus" class="w-full p-2 border rounded">
                    <option value="TO_PRICE">To Price</option>
                    <option value="PRICED">Priced</option>
                    <option value="AWARDED">Awarded</option>
                </select>
                <input type="text" id="tenderValue" placeholder="Estimated Value" class="w-full p-2 border rounded">
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeTenderModal()" class="px-4 py-2 border rounded">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-[#771414] text-white rounded">Save Tender</button>
                </div>
            </form>
        </div>
    </div>

    <div id="toastContainer" class="fixed bottom-4 right-4 z-50"></div>

    <script>
        let currentUser = null;
        let isDemoMode = false;
        let currentRegion = 'SEQ-BCC';
        let currentMainTab = 'tenders';
        let database = { tenders: [], crmContacts: [] };

        const qldRegions = [
            { id: 'SEQ-BCC', name: 'Brisbane City', zone: 'SEQ' },
            { id: 'SEQ-GC', name: 'Gold Coast', zone: 'SEQ' },
            { id: 'NQ-TC', name: 'Townsville City', zone: 'NQ' },
            { id: 'CQ-BRC', name: 'Bundaberg Regional', zone: 'CQ' }
            // Add other LGAs as needed
        ];

        async function initializeDatabase() {
            if (isDemoMode) return;
            updateSyncStatus('Syncing...');

            // Real-time listener for Tenders
            db.collection('tenders').onSnapshot(snapshot => {
                database.tenders = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                if (currentMainTab === 'tenders') loadRegion(currentRegion);
                updateSyncStatus('Synced');
            });

            // Real-time listener for CRM
            db.collection('crmContacts').onSnapshot(snapshot => {
                database.crmContacts = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                if (currentMainTab === 'crm') renderCRMContacts();
            });
        }

        async function saveTender(event) {
            event.preventDefault();
            const id = document.getElementById('tenderId').value || Date.now().toString();
            const tenderData = {
                id: id,
                regionId: document.getElementById('tenderRegion').value || currentRegion,
                title: document.getElementById('tenderTitle').value,
                status: document.getElementById('tenderStatus').value,
                value: document.getElementById('tenderValue').value,
                updatedAt: new Date().toISOString()
            };

            if (isDemoMode) {
                database.tenders = database.tenders.filter(t => t.id !== id);
                database.tenders.push(tenderData);
                loadRegion(currentRegion);
            } else {
                await db.collection('tenders').doc(id).set(tenderData, { merge: true });
            }
            closeTenderModal();
            showToast('Tender Saved');
        }

        async function deleteTender(id) {
            if (!confirm('Delete this tender?')) return;
            if (isDemoMode) {
                database.tenders = database.tenders.filter(t => t.id !== id);
                loadRegion(currentRegion);
            } else {
                await db.collection('tenders').doc(String(id)).delete();
            }
            showToast('Tender Removed');
        }

        async function saveCRM(event) {
            event.preventDefault();
            const id = document.getElementById('crmContactId').value || Date.now().toString();
            const contactData = {
                id: id,
                category: document.getElementById('crmCategory').value,
                name: document.getElementById('crmName').value,
                position: document.getElementById('crmPosition').value,
                email: document.getElementById('crmEmail').value,
                updatedAt: new Date().toISOString()
            };

            if (isDemoMode) {
                database.crmContacts = database.crmContacts.filter(c => c.id !== id);
                database.crmContacts.push(contactData);
                renderCRMContacts();
            } else {
                await db.collection('crmContacts').doc(id).set(contactData, { merge: true });
            }
            closeCRMModal();
            showToast('Contact Saved');
        }

        async function deleteCRMContact(id) {
            if (!confirm('Delete this contact?')) return;
            if (isDemoMode) {
                database.crmContacts = database.crmContacts.filter(c => c.id !== id);
                renderCRMContacts();
            } else {
                await db.collection('crmContacts').doc(String(id)).delete();
            }
            showToast('Contact Removed');
        }

        function loadRegion(regionId) {
            currentRegion = regionId;
            const container = document.getElementById('regionContent');
            const tenders = database.tenders.filter(t => t.regionId === regionId);
            
            container.innerHTML = tenders.map(t => `
                <div class="region-card p-5 rounded-xl shadow-sm card-hover">
                    <div class="flex justify-between mb-2">
                        <span class="text-xs font-bold uppercase">${t.status}</span>
                        <div class="flex gap-2">
                            <button onclick="editTender('${t.id}')" class="text-blue-600"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteTender('${t.id}')" class="text-red-600"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <h3 class="font-bold">${t.title}</h3>
                    <p class="text-sm text-gray-500">${t.value}</p>
                </div>
            `).join('');

            if (tenders.length === 0) container.innerHTML = '<p class="col-span-full text-center text-gray-400">No tenders found</p>';
        }

        function renderCRMContacts() {
            const container = document.getElementById('crmContactsList');
            container.innerHTML = database.crmContacts.map(c => `
                <div class="bg-white p-5 rounded-xl border-l-4 ${getCategoryClass(c.category)} shadow-sm">
                    <div class="flex justify-between">
                        <div>
                            <h4 class="font-bold">${c.name}</h4>
                            <p class="text-sm text-gray-600">${c.position}</p>
                            <p class="text-xs text-blue-600">${c.email}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editCRMContact('${c.id}')"><i class="fas fa-edit text-gray-400"></i></button>
                            <button onclick="deleteCRMContact('${c.id}')"><i class="fas fa-trash text-red-400"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getCategoryClass(cat) {
            return {
                'Council': 'border-blue-500',
                'Supplier': 'border-green-500',
                'Contractor': 'border-orange-500',
                'Competitor': 'border-red-500'
            }[cat] || 'border-gray-500';
        }

        function switchMainTab(tab) {
            currentMainTab = tab;
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.querySelectorAll('.main-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('content-' + tab).classList.remove('hidden');
            if (tab === 'crm') renderCRMContacts();
            if (tab === 'tenders') loadRegion(currentRegion);
        }

        async function checkUserApproval(user) {
            const doc = await db.collection('approvedUsers').doc(user.uid).get();
            if (doc.exists && doc.data().approved) {
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                initializeDatabase();
                renderCRMContacts(); // Fix button mapping
                checkAdminStatus();
            } else {
                auth.signOut();
                showToast('Awaiting Admin Approval', 'warning');
            }
        }

        async function checkAdminStatus() {
            const doc = await db.collection('admins').doc(currentUser.uid).get();
            if (doc.exists) document.getElementById('adminButton').classList.remove('hidden');
        }

        function signIn() {
            const e = document.getElementById('authEmail').value;
            const p = document.getElementById('authPassword').value;
            auth.signInWithEmailAndPassword(e, p).catch(err => showToast(err.message, 'error'));
        }

        function signOut() { auth.signOut(); location.reload(); }

        function showAddCRMModal() {
            document.getElementById('crmForm').reset();
            document.getElementById('crmContactId').value = '';
            document.getElementById('crmModal').classList.remove('hidden');
        }

        function closeCRMModal() { document.getElementById('crmModal').classList.add('hidden'); }

        function showToast(msg, type = 'info') {
            const t = document.createElement('div');
            t.className = `toast mb-2 p-4 rounded text-white bg-gray-800 shadow-lg`;
            t.textContent = msg;
            document.getElementById('toastContainer').appendChild(t);
            setTimeout(() => t.classList.add('show'), 100);
            setTimeout(() => t.remove(), 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const tabs = document.getElementById('regionTabs');
            tabs.innerHTML = qldRegions.map(r => `
                <button onclick="loadRegion('${r.id}')" class="px-4 py-2 bg-white rounded-full border text-sm">${r.name}</button>
            `).join('');
            loadRegion(currentRegion);
        });
    </script>
</body>
</html>
