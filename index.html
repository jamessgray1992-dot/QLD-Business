<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QLD Business Development & CRM System - All 77 LGAs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        :root {
            --qld-maroon: #771414;
            --qld-gold: #FFCD00;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f0;
            background-image: radial-gradient(at 0% 0%, rgba(119, 20, 20, 0.03) 0px, transparent 50%);
        }
        
        h1, h2, h3, .display-font {
            font-family: 'Space Grotesk', sans-serif;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .region-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            border-left: 4px solid var(--qld-maroon);
        }
        
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .sync-indicator {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        
        .priority-high { border-left-color: #dc2626; }
        .priority-medium { border-left-color: #f59e0b; }
        .priority-low { border-left-color: #10b981; }
        
        .offline-banner {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            color: white;
            transform: translateY(-100%);
            transition: transform 0.3s;
        }
        
        .offline-banner.show {
            transform: translateY(0);
        }
        
        .region-scroll::-webkit-scrollbar {
            height: 6px;
        }
        
        .region-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .region-scroll::-webkit-scrollbar-thumb {
            background: #771414;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .toast {
            transform: translateX(120%);
            transition: transform 0.3s ease-out;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--qld-maroon), var(--qld-gold));
        }
        
        .region-group {
            background: linear-gradient(135deg, #fafafa 0%, #f0f0f0 100%);
            border: 1px solid #e5e7eb;
        }
        
        .demo-badge {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        .main-tab {
            position: relative;
            transition: all 0.3s;
        }
        
        .main-tab.active {
            color: #771414;
            font-weight: 600;
        }
        
        .main-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: #771414;
            border-radius: 3px 3px 0 0;
        }
        
        .status-to-price { background: #dbeafe; color: #1e40af; }
        .status-priced { background: #dcfce7; color: #166534; }
        .status-not-pricing { background: #f3f4f6; color: #6b7280; }
        
        .crm-contact-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 4px solid #3b82f6;
        }
        
        .interaction-timeline {
            position: relative;
            padding-left: 20px;
        }
        
        .interaction-timeline::before {
            content: '';
            position: absolute;
            left: 6px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e5e7eb;
        }
        
        .timeline-dot {
            position: absolute;
            left: 0;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #3b82f6;
            border: 3px solid white;
            box-shadow: 0 0 0 2px #e5e7eb;
        }
        
        .not-won-card {
            background: linear-gradient(135deg, #ffffff 0%, #fef2f2 100%);
            border-left: 4px solid #ef4444;
        }
    </style>
</head>
<body class="text-gray-800 min-h-screen">

    <!-- Offline Warning -->
    <div id="offlineBanner" class="offline-banner fixed top-0 left-0 right-0 z-50 px-4 py-2 text-center text-sm font-medium">
        <i class="fas fa-wifi-slash mr-2"></i> You're offline. Changes will sync when you reconnect.
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl max-w-md w-full p-8 shadow-2xl">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-gradient-to-br from-[#771414] to-[#9f1c1c] rounded-full flex items-center justify-center text-white text-2xl mx-auto mb-4">
                    <i class="fas fa-building"></i>
                </div>
                <h2 class="text-2xl font-bold display-font">QLD Business Report</h2>
                <p class="text-gray-500 mt-2">All 77 Local Government Areas</p>
            </div>
            
            <div id="authForm">
                <input type="email" id="authEmail" placeholder="Email address" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 mb-3 focus:border-[#771414] focus:outline-none">
                <input type="password" id="authPassword" placeholder="Password" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 mb-4 focus:border-[#771414] focus:outline-none">
                
                <button onclick="signIn()" class="w-full py-3 bg-[#771414] text-white rounded-lg font-medium hover:bg-[#5a1010] transition-colors mb-3">
                    Sign In
                </button>
                
                <button onclick="signUp()" class="w-full py-3 border-2 border-[#771414] text-[#771414] rounded-lg font-medium hover:bg-red-50 transition-colors mb-4">
                    Create Account
                </button>
                
                <div class="relative mb-4">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">or</span>
                    </div>
                </div>
                
                <button onclick="enterDemoMode()" class="w-full py-3 bg-gray-800 text-white rounded-lg font-medium hover:bg-gray-900 transition-colors flex items-center justify-center">
                    <i class="fas fa-play-circle mr-2"></i> Continue in Demo Mode
                </button>

<button onclick="emergencyAdminLogin()" style="display:none;" id="emergencyBtn">Emergency Admin</button>
                
                <p class="text-xs text-center text-gray-400 mt-4">
                    Demo mode stores data locally on your device. No account required.
                </p>
            </div>
        </div>
    </div>

    <!-- Main App (Hidden until auth or demo) -->
    <div id="mainApp" class="hidden">
        
        <!-- Navigation -->
        <nav class="glass-panel sticky top-0 z-40 border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16 items-center">
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 bg-gradient-to-br from-[#771414] to-[#9f1c1c] rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-lg">
                            QLD
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-gray-900 display-font tracking-tight">Business Development & CRM</h1>
                            <div class="flex items-center space-x-2 text-xs text-gray-500">
                                <span id="userEmail"></span>
                                <span id="demoBadge" class="hidden demo-badge">DEMO MODE</span>
                                <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                                <span id="syncStatus" class="flex items-center text-green-600">
                                    <i class="fas fa-check-circle mr-1"></i> Ready
                                </span>
                                <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                                <span class="text-[#771414] font-semibold">77 LGAs</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Admin Button - Hidden by default -->
                        <button id="adminButton" onclick="showAdminPanel()" class="hidden px-4 py-2 bg-[#771414] text-white rounded-lg hover:bg-[#5a1010] text-sm font-medium transition-colors shadow-sm">
                            <i class="fas fa-shield-alt mr-2"></i> Admin
                        </button>
                        
                        <button onclick="exportToExcel()" class="hidden md:flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors shadow-sm">
                            <i class="fas fa-file-excel mr-2"></i> Export Excel
                        </button>
                        
                        <button onclick="shareReport()" class="hidden md:flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors shadow-sm">
                            <i class="fas fa-share-alt mr-2"></i> Share
                        </button>
                        
                        <button onclick="signOut()" class="px-4 py-2 text-gray-600 hover:text-gray-900 text-sm font-medium">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                        
                        <div class="relative">
                            <input type="text" id="globalSearch" placeholder="Search all 77 LGAs..." 
                                   class="pl-10 pr-4 py-2 rounded-full bg-gray-100 border-none focus:ring-2 focus:ring-[#771414] w-56 text-sm"
                                   onkeyup="globalSearch()">
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Navigation Tabs -->
        <div class="bg-white border-b border-gray-200 sticky top-16 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex space-x-8">
                    <button onclick="switchMainTab('tenders')" id="tab-tenders" class="main-tab active py-4 px-2 text-sm font-medium text-gray-600 hover:text-gray-900 flex items-center">
                        <i class="fas fa-file-contract mr-2 text-[#771414]"></i> Tenders & Opportunities
                    </button>
                    <button onclick="switchMainTab('crm')" id="tab-crm" class="main-tab py-4 px-2 text-sm font-medium text-gray-600 hover:text-gray-900 flex items-center">
                        <i class="fas fa-users mr-2 text-blue-600"></i> CRM & Contacts
                    </button>
                    <button onclick="switchMainTab('analytics')" id="tab-analytics" class="main-tab py-4 px-2 text-sm font-medium text-gray-600 hover:text-gray-900 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-green-600"></i> Analytics & Pipeline
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            <!-- TENDERS TAB CONTENT -->
            <div id="content-tenders" class="main-content">
                
                <!-- Dashboard Stats -->
                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                    <div class="stat-card rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">To Price</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="statToPrice">-</h3>
                            </div>
                            <div class="p-2 bg-blue-50 rounded-lg">
                                <i class="fas fa-calculator text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">Priced</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="statPriced">-</h3>
                            </div>
                            <div class="p-2 bg-green-50 rounded-lg">
                                <i class="fas fa-check-circle text-green-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">Not Pricing</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="statNotPricing">-</h3>
                            </div>
                            <div class="p-2 bg-gray-50 rounded-lg">
                                <i class="fas fa-ban text-gray-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stat-card rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">Awarded</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="statAwarded">-</h3>
                            </div>
                            <div class="p-2 bg-yellow-50 rounded-lg">
                                <i class="fas fa-trophy text-yellow-600"></i>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Total: <span id="statTotalValue">-</span></p>
                    </div>
                    
                    <div class="stat-card rounded-xl p-5 shadow-sm">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-xs font-medium text-gray-600 mb-1">Not Won</p>
                                <h3 class="text-2xl font-bold text-gray-900" id="statNotWon">-</h3>
                            </div>
                            <div class="p-2 bg-red-50 rounded-lg">
                                <i class="fas fa-times-circle text-red-600"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Region Selector -->
                <div class="mb-8">
                    <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold display-font text-gray-900">Select Region</h2>
                            <p class="text-sm text-gray-500 mt-1">Browse by zone or search all 77 Queensland LGAs</p>
                        </div>
                        
                        <!-- Zone Filter -->
                        <div class="flex flex-wrap gap-2">
                            <button onclick="filterByZone('all')" class="zone-filter px-4 py-2 rounded-full text-sm font-medium bg-[#771414] text-white shadow-md transition-all" data-zone="all">
                                All Zones
                            </button>
                            <button onclick="filterByZone('SEQ')" class="zone-filter px-4 py-2 rounded-full text-sm font-medium bg-white text-gray-600 hover:bg-gray-100 border border-gray-200 transition-all" data-zone="SEQ">
                                South East QLD
                            </button>
                            <button onclick="filterByZone('NQ')" class="zone-filter px-4 py-2 rounded-full text-sm font-medium bg-white text-gray-600 hover:bg-gray-100 border border-gray-200 transition-all" data-zone="NQ">
                                North QLD
                            </button>
                            <button onclick="filterByZone('CQ')" class="zone-filter px-4 py-2 rounded-full text-sm font-medium bg-white text-gray-600 hover:bg-gray-100 border border-gray-200 transition-all" data-zone="CQ">
                                Central QLD
                            </button>
                            <button onclick="filterByZone('SWQ')" class="zone-filter px-4 py-2 rounded-full text-sm font-medium bg-white text-gray-600 hover:bg-gray-100 border border-gray-200 transition-all" data-zone="SWQ">
                                South West QLD
                            </button>
                            <button onclick="filterByZone('FWQ')" class="zone-filter px-4 py-2 rounded-full text-sm font-medium bg-white text-gray-600 hover:bg-gray-100 border border-gray-200 transition-all" data-zone="FWQ">
                                Far North QLD
                            </button>
                        </div>
                    </div>
                    
                    <!-- Region Tabs Container -->
                    <div class="region-group rounded-xl p-4 mb-6">
                        <div class="flex space-x-2 overflow-x-auto pb-2 region-scroll" id="regionTabs" style="max-height: 200px; flex-wrap: wrap;">
                            <!-- Tabs injected by JS -->
                        </div>
                    </div>
                    
                    <div id="regionContent" class="space-y-6">
                        <div class="flex items-center justify-center h-64">
                            <div class="loading-skeleton w-full h-full rounded-xl"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CRM TAB CONTENT -->
            <div id="content-crm" class="main-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold display-font text-gray-900 mb-2">Customer Relationship Management</h2>
                    <p class="text-gray-600">Manage all your council contacts, interactions, and relationship history across all 77 LGAs.</p>
                </div>

                <!-- CRM Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                    <div class="bg-blue-50 rounded-xl p-5 border border-blue-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-blue-600 font-medium">Total Contacts</p>
                                <h3 class="text-3xl font-bold text-blue-900" id="crmTotalContacts">-</h3>
                            </div>
                            <i class="fas fa-address-book text-blue-400 text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-green-50 rounded-xl p-5 border border-green-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-green-600 font-medium">Active Relationships</p>
                                <h3 class="text-3xl font-bold text-green-900" id="crmActiveContacts">-</h3>
                            </div>
                            <i class="fas fa-handshake text-green-400 text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-purple-50 rounded-xl p-5 border border-purple-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-purple-600 font-medium">Interactions (30 days)</p>
                                <h3 class="text-3xl font-bold text-purple-900" id="crmRecentInteractions">-</h3>
                            </div>
                            <i class="fas fa-comments text-purple-400 text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-orange-50 rounded-xl p-5 border border-orange-100">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-orange-600 font-medium">Follow-ups Due</p>
                                <h3 class="text-3xl font-bold text-orange-900" id="crmFollowups">-</h3>
                            </div>
                            <i class="fas fa-bell text-orange-400 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- CRM Filters -->
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <div class="flex-1">
                        <input type="text" id="crmSearch" placeholder="Search contacts by name, position, or council..." 
                               class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none"
                               onkeyup="searchCRM()">
                    </div>
                    <select id="crmRegionFilter" onchange="filterCRMByRegion()" class="px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                        <option value="all">All Regions</option>
                        <!-- Options populated by JS -->
                    </select>
                    <button onclick="showAddCRMModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        <i class="fas fa-plus mr-2"></i> Add Contact
                    </button>
                </div>

                <!-- CRM Contacts List -->
                <div id="crmContactsList" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- ANALYTICS TAB CONTENT -->
            <div id="content-analytics" class="main-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold display-font text-gray-900 mb-2">Analytics & Pipeline</h2>
                    <p class="text-gray-600">Track your win rates, pricing performance, and pipeline value across all regions.</p>
                </div>

                <!-- Analytics Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <!-- Win Rate Card -->
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                        <h3 class="text-lg font-bold mb-4">Win Rate Analysis</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                <span class="text-gray-600">Total Tenders Priced</span>
                                <span class="font-bold text-xl" id="analyticsTotalPriced">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                <span class="text-green-700">Won</span>
                                <span class="font-bold text-xl text-green-700" id="analyticsWon">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                <span class="text-red-700">Lost</span>
                                <span class="font-bold text-xl text-red-700" id="analyticsLost">0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                <span class="text-blue-700">Win Rate</span>
                                <span class="font-bold text-xl text-blue-700" id="analyticsWinRate">0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pipeline Value Card -->
                    <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                        <h3 class="text-lg font-bold mb-4">Pipeline Value</h3>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                <span class="text-blue-700">To Price</span>
                                <span class="font-bold text-xl text-blue-700" id="analyticsToPriceValue">$0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                <span class="text-green-700">Priced & Submitted</span>
                                <span class="font-bold text-xl text-green-700" id="analyticsPricedValue">$0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                                <span class="text-yellow-700">Awarded Value</span>
                                <span class="font-bold text-xl text-yellow-700" id="analyticsAwardedValue">$0</span>
                            </div>
                            <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                                <span class="text-purple-700">Total Pipeline</span>
                                <span class="font-bold text-xl text-purple-700" id="analyticsTotalPipeline">$0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Region Performance -->
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <h3 class="text-lg font-bold mb-4">Performance by Region</h3>
                    <div id="regionPerformanceList" class="space-y-3">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

        </div>

        <!-- Tender Entry Modal -->
        <div id="tenderModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
                    <h3 class="text-xl font-bold display-font" id="tenderModalTitle">Add New Tender</h3>
                    <button onclick="closeTenderModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="tenderForm" class="p-6 space-y-4">
                    <input type="hidden" id="tenderId">
                    <input type="hidden" id="tenderRegion">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Project Title *</label>
                            <input type="text" id="tenderTitle" required class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <select id="tenderCategory" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none bg-white">
                                <option value="Infrastructure">Infrastructure</option>
                                <option value="Construction">Construction</option>
                                <option value="Professional Services">Professional Services</option>
                                <option value="IT & Digital">IT & Digital</option>
                                <option value="Environmental">Environmental</option>
                                <option value="Community Services">Community Services</option>
                                <option value="Waste Management">Waste Management</option>
                                <option value="Water & Sewerage">Water & Sewerage</option>
                                <option value="Roads & Transport">Roads & Transport</option>
                                <option value="Parks & Recreation">Parks & Recreation</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                            <select id="tenderStatus" required onchange="togglePricingFields()" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none bg-white">
                                <option value="TO_PRICE">TO PRICE</option>
                                <option value="PRICED">PRICED</option>
                                <option value="NOT_PRICING">NOT PRICING</option>
                                <option value="AWARDED">AWARDED</option>
                                <option value="NOT_WON">NOT WON</option>
                            </select>
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Estimated Value ($)</label>
                            <input type="text" id="tenderValue" placeholder="$0.00" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Closing Date</label>
                            <input type="date" id="tenderClosingDate" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                        </div>
                        
                        <!-- PRICED Fields -->
                        <div id="pricedFields" class="col-span-2 hidden border-t pt-4 mt-2">
                            <h4 class="font-semibold text-green-700 mb-3 flex items-center">
                                <i class="fas fa-check-circle mr-2"></i> Pricing Details
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Our Price ($)</label>
                                    <input type="text" id="ourPrice" placeholder="$0.00" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Submission Date</label>
                                    <input type="date" id="submissionDate" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                                </div>
                            </div>
                        </div>
                        
                        <!-- NOT PRICING Fields -->
                        <div id="notPricingFields" class="col-span-2 hidden border-t pt-4 mt-2">
                            <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                                <i class="fas fa-ban mr-2"></i> Reason for Not Pricing
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
                                    <select id="notPricingReason" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none bg-white">
                                        <option value="">Select reason...</option>
                                        <option value="Capacity">At Capacity</option>
                                        <option value="Capability">Outside Capability</option>
                                        <option value="Location">Too Remote</option>
                                        <option value="Value">Too Small/Large</option>
                                        <option value="Conflict">Conflict of Interest</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Comments</label>
                                    <textarea id="notPricingComments" rows="2" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- AWARDED Fields -->
                        <div id="awardedFields" class="col-span-2 hidden border-t pt-4 mt-2">
                            <h4 class="font-semibold text-yellow-700 mb-3 flex items-center">
                                <i class="fas fa-trophy mr-2"></i> Award Details
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Awarded Date</label>
                                    <input type="date" id="awardedDate" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Contract Value ($)</label>
                                    <input type="text" id="awardedValue" placeholder="$0.00" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Scope Summary</label>
                                    <textarea id="awardedScope" rows="2" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- NOT WON Fields -->
                        <div id="notWonFields" class="col-span-2 hidden border-t pt-4 mt-2">
                            <h4 class="font-semibold text-red-700 mb-3 flex items-center">
                                <i class="fas fa-times-circle mr-2"></i> Competitor Information
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Who Won?</label>
                                    <input type="text" id="winnerName" placeholder="Company name" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Their Price ($) (if known)</label>
                                    <input type="text" id="winnerPrice" placeholder="$0.00" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Our Price ($)</label>
                                    <input type="text" id="ourLosingPrice" placeholder="$0.00" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Announced</label>
                                    <input type="date" id="resultDate" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Comments / Lessons Learned</label>
                                    <textarea id="notWonComments" rows="3" placeholder="Why did we lose? What could we do better next time?" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-span-2 border-t pt-4 mt-2">
                            <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                                <i class="fas fa-user-tie mr-2 text-[#771414]"></i> Council Contact Details
                            </h4>
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Name</label>
                            <input type="text" id="tenderContactName" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Position</label>
                            <input type="text" id="tenderContactPosition" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input type="email" id="tenderContactEmail" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Phone</label>
                            <input type="tel" id="tenderContactPhone" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none">
                        </div>
                        
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Project Description</label>
                            <textarea id="tenderDescription" rows="3" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-[#771414] focus:outline-none"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeTenderModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-[#771414] text-white rounded-lg hover:bg-[#5a1010] transition-colors shadow-lg">
                            <i class="fas fa-save mr-2"></i> Save Tender
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- CRM Contact Modal -->
        <div id="crmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
                    <h3 class="text-xl font-bold display-font" id="crmModalTitle">Add CRM Contact</h3>
                    <button onclick="closeCRMModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="crmForm" class="p-6 space-y-4">
                    <input type="hidden" id="crmContactId">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Region *</label>
                            <select id="crmRegion" required class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                                <!-- Populated by JS -->
                            </select>
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Contact Type</label>
                            <select id="crmType" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                                <option value="Procurement">Procurement</option>
                                <option value="Engineering">Engineering</option>
                                <option value="Management">Management</option>
                                <option value="Elected">Elected Member</option>
                                <option value="Operations">Operations</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                            <input type="text" id="crmName" required class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Position/Title *</label>
                            <input type="text" id="crmPosition" required class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                            <input type="text" id="crmDepartment" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Direct Phone</label>
                            <input type="tel" id="crmDirectPhone" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
                            <input type="tel" id="crmMobile" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>
                        
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email *</label>
                            <input type="email" id="crmEmail" required class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>
                        
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">LinkedIn Profile</label>
                            <input type="url" id="crmLinkedIn" placeholder="https://linkedin.com/in/ ..." class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                        </div>
                        
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Relationship Notes</label>
                            <textarea id="crmNotes" rows="3" placeholder="How did you meet? Interests, family, preferences..." class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none"></textarea>
                        </div>
                        
                        <div class="col-span-2 border-t pt-4 mt-2">
                            <h4 class="font-semibold text-blue-900 mb-3 flex items-center">
                                <i class="fas fa-clock mr-2"></i> Last Interaction
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                    <input type="date" id="crmLastContactDate" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                                    <select id="crmLastContactType" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                                        <option value="">Select...</option>
                                        <option value="Meeting">Meeting</option>
                                        <option value="Phone">Phone Call</option>
                                        <option value="Email">Email</option>
                                        <option value="Event">Industry Event</option>
                                        <option value="Tender">Tender Discussion</option>
                                    </select>
                                </div>
                                <div class="col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes from Last Contact</label>
                                    <textarea id="crmLastContactNotes" rows="2" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-span-2 border-t pt-4 mt-2">
                            <h4 class="font-semibold text-orange-900 mb-3 flex items-center">
                                <i class="fas fa-bell mr-2"></i> Follow-up Reminder
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Next Follow-up Date</label>
                                    <input type="date" id="crmFollowUpDate" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                                </div>
                                <div class="col-span-2 md:col-span-1">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                    <select id="crmPriority" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                                        <option value="High">High</option>
                                        <option value="Medium" selected>Medium</option>
                                        <option value="Low">Low</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeCRMModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-lg">
                            <i class="fas fa-save mr-2"></i> Save Contact
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Interaction Modal -->
        <div id="interactionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl max-w-lg w-full shadow-2xl">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
                    <h3 class="text-xl font-bold display-font">Add Interaction</h3>
                    <button onclick="closeInteractionModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <form id="interactionForm" class="p-6 space-y-4">
                    <input type="hidden" id="interactionContactId">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                        <input type="date" id="interactionDate" required class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type *</label>
                        <select id="interactionType" required class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none bg-white">
                            <option value="Meeting">Meeting</option>
                            <option value="Phone">Phone Call</option>
                            <option value="Email">Email</option>
                            <option value="Video">Video Call</option>
                            <option value="Event">Industry Event</option>
                            <option value="Site Visit">Site Visit</option>
                            <option value="Tender Discussion">Tender Discussion</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes *</label>
                        <textarea id="interactionNotes" required rows="4" placeholder="What was discussed? Any action items?" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Next Steps</label>
                        <input type="text" id="interactionNextSteps" placeholder="Any follow-up required?" class="w-full rounded-lg px-4 py-2 border-2 border-gray-200 focus:border-blue-500 focus:outline-none">
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4 border-t">
                        <button type="button" onclick="closeInteractionModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors shadow-lg">
                            <i class="fas fa-plus mr-2"></i> Add Interaction
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Admin Panel Modal -->
        <div id="adminPanel" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center z-10">
                    <h3 class="text-xl font-bold display-font flex items-center">
                        <i class="fas fa-shield-alt mr-2 text-[#771414]"></i> Admin Approval Panel
                    </h3>
                    <button onclick="closeAdminPanel()" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="p-6">
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-900 mb-2">Pending Approval Requests</h4>
                        <p class="text-sm text-gray-500">Review and approve new user registrations</p>
                    </div>
                    
                    <div id="pendingApprovalsList" class="space-y-4">
                        <div class="text-center py-8 text-gray-400">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                            <p>Loading requests...</p>
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t">
                        <h4 class="font-semibold text-gray-900 mb-2">Approved Users</h4>
                        <div id="approvedUsersList" class="space-y-2">
                            <div class="text-center py-4 text-gray-400">
                                <p>Loading approved users...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

        <!-- Quick Actions -->
        <div class="fixed bottom-8 right-8 flex flex-col space-y-3">
            <button onclick="quickAdd()" class="w-14 h-14 bg-[#771414] text-white rounded-full shadow-lg hover:shadow-xl transform hover:scale-110 transition-all flex items-center justify-center group relative">
                <i class="fas fa-plus text-xl"></i>
                <span class="absolute right-16 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Quick Add</span>
            </button>
        </div>
    </div>

    <script>
        // ==================== ALL 77 QUEENSLAND LGAs ====================
        const qldRegions = [
            // SOUTH EAST QUEENSLAND (SEQ) - 20 LGAs
            { id: 'brisbane', name: 'Brisbane City Council', type: 'City', population: '1.2M', zone: 'SEQ', region: 'Metropolitan' },
            { id: 'goldcoast', name: 'Gold Coast City Council', type: 'City', population: '600K', zone: 'SEQ', region: 'Metropolitan' },
            { id: 'moretonbay', name: 'Moreton Bay Regional Council', type: 'Regional', population: '460K', zone: 'SEQ', region: 'Metropolitan' },
            { id: 'logan', name: 'Logan City Council', type: 'City', population: '320K', zone: 'SEQ', region: 'Metropolitan' },
            { id: 'redland', name: 'Redland City Council', type: 'City', population: '160K', zone: 'SEQ', region: 'Metropolitan' },
            { id: 'ipswich', name: 'Ipswich City Council', type: 'City', population: '200K', zone: 'SEQ', region: 'Metropolitan' },
            { id: 'toowoomba', name: 'Toowoomba Regional Council', type: 'Regional', population: '170K', zone: 'SEQ', region: 'Darling Downs' },
            { id: 'sunshinecoast', name: 'Sunshine Coast Regional Council', type: 'Regional', population: '300K', zone: 'SEQ', region: 'Coastal' },
            { id: 'noosa', name: 'Noosa Shire Council', type: 'Shire', population: '55K', zone: 'SEQ', region: 'Coastal' },
            { id: 'somerset', name: 'Somerset Regional Council', type: 'Regional', population: '25K', zone: 'SEQ', region: 'Rural' },
            { id: 'lockyervalley', name: 'Lockyer Valley Regional Council', type: 'Regional', population: '40K', zone: 'SEQ', region: 'Rural' },
            { id: 'scenicrim', name: 'Scenic Rim Regional Council', type: 'Regional', population: '42K', zone: 'SEQ', region: 'Rural' },
            { id: 'southburnett', name: 'South Burnett Regional Council', type: 'Regional', population: '33K', zone: 'SEQ', region: 'Rural' },
            { id: 'westerndowns', name: 'Western Downs Regional Council', type: 'Regional', population: '35K', zone: 'SEQ', region: 'Darling Downs' },
            { id: 'goondiwindi', name: 'Goondiwindi Regional Council', type: 'Regional', population: '11K', zone: 'SEQ', region: 'Darling Downs' },
            { id: 'southerndowns', name: 'Southern Downs Regional Council', type: 'Regional', population: '35K', zone: 'SEQ', region: 'Darling Downs' },
            { id: 'northburnett', name: 'North Burnett Regional Council', type: 'Regional', population: '11K', zone: 'SEQ', region: 'Wide Bay' },
            { id: 'bundaberg', name: 'Bundaberg Regional Council', type: 'Regional', population: '95K', zone: 'SEQ', region: 'Wide Bay' },
            { id: 'frasercoast', name: 'Fraser Coast Regional Council', type: 'Regional', population: '105K', zone: 'SEQ', region: 'Wide Bay' },
            { id: 'gympie', name: 'Gympie Regional Council', type: 'Regional', population: '51K', zone: 'SEQ', region: 'Wide Bay' },

            // NORTH QUEENSLAND (NQ) - 11 LGAs
            { id: 'townsville', name: 'Townsville City Council', type: 'City', population: '190K', zone: 'NQ', region: 'North Coast' },
            { id: 'mackay', name: 'Mackay Regional Council', type: 'Regional', population: '120K', zone: 'NQ', region: 'North Coast' },
            { id: 'whitsunday', name: 'Whitsunday Regional Council', type: 'Regional', population: '35K', zone: 'NQ', region: 'North Coast' },
            { id: 'burdekin', name: 'Burdekin Shire Council', type: 'Shire', population: '17K', zone: 'NQ', region: 'North Coast' },
            { id: 'charterstowers', name: 'Charters Towers Regional Council', type: 'Regional', population: '12K', zone: 'NQ', region: 'Inland' },
            { id: 'hinchinbrook', name: 'Hinchinbrook Shire Council', type: 'Shire', population: '11K', zone: 'NQ', region: 'North Coast' },
            { id: 'mounthypipamee', name: 'Mount Hypipamee Shire Council', type: 'Shire', population: '3K', zone: 'NQ', region: 'Tablelands' },
            { id: 'tablelands', name: 'Tablelands Regional Council', type: 'Regional', population: '26K', zone: 'NQ', region: 'Tablelands' },
            { id: 'cassowarycoast', name: 'Cassowary Coast Regional Council', type: 'Regional', population: '30K', zone: 'NQ', region: 'North Coast' },
            { id: 'cairns', name: 'Cairns Regional Council', type: 'Regional', population: '165K', zone: 'NQ', region: 'Far North' },
            { id: 'yarrabah', name: 'Yarrabah Aboriginal Shire Council', type: 'Aboriginal Shire', population: '2.5K', zone: 'NQ', region: 'Far North' },

            // CENTRAL QUEENSLAND (CQ) - 13 LGAs
            { id: 'rockhampton', name: 'Rockhampton Regional Council', type: 'Regional', population: '80K', zone: 'CQ', region: 'Central' },
            { id: 'gladstone', name: 'Gladstone Regional Council', type: 'Regional', population: '63K', zone: 'CQ', region: 'Central Coast' },
            { id: 'banana', name: 'Banana Shire Council', type: 'Shire', population: '14K', zone: 'CQ', region: 'Central Inland' },
            { id: 'centralhighlands', name: 'Central Highlands Regional Council', type: 'Regional', population: '12K', zone: 'CQ', region: 'Central Inland' },
            { id: 'woorabinda', name: 'Woorabinda Aboriginal Shire Council', type: 'Aboriginal Shire', population: '1K', zone: 'CQ', region: 'Central' },
            { id: 'livingstone', name: 'Livingstone Shire Council', type: 'Shire', population: '38K', zone: 'CQ', region: 'Central Coast' },
            { id: 'isaac', name: 'Isaac Regional Council', type: 'Regional', population: '22K', zone: 'CQ', region: 'Central Inland' },
            { id: 'barcaldine', name: 'Barcaldine Regional Council', type: 'Regional', population: '3K', zone: 'CQ', region: 'Central West' },
            { id: 'barcoo', name: 'Barcoo Shire Council', type: 'Shire', population: '300', zone: 'CQ', region: 'Central West' },
            { id: 'blackalltambo', name: 'Blackall-Tambo Regional Council', type: 'Regional', population: '2K', zone: 'CQ', region: 'Central West' },
            { id: 'diamantina', name: 'Diamantina Shire Council', type: 'Shire', population: '300', zone: 'CQ', region: 'Central West' },
            { id: 'longreach', name: 'Longreach Regional Council', type: 'Regional', population: '4K', zone: 'CQ', region: 'Central West' },
            { id: 'wooramel', name: 'Wooramel Shire Council', type: 'Shire', population: '200', zone: 'CQ', region: 'Central West' },

            // SOUTH WEST QUEENSLAND (SWQ) - 14 LGAs
            { id: 'maranoa', name: 'Maranoa Regional Council', type: 'Regional', population: '13K', zone: 'SWQ', region: 'South West' },
            { id: 'balonne', name: 'Balonne Shire Council', type: 'Shire', population: '4K', zone: 'SWQ', region: 'South West' },
            { id: 'bulloo', name: 'Bulloo Shire Council', type: 'Shire', population: '400', zone: 'SWQ', region: 'South West' },
            { id: 'murweh', name: 'Murweh Shire Council', type: 'Shire', population: '4K', zone: 'SWQ', region: 'South West' },
            { id: 'paroo', name: 'Paroo Shire Council', type: 'Shire', population: '1.5K', zone: 'SWQ', region: 'South West' },
            { id: 'quilpie', name: 'Quilpie Shire Council', type: 'Shire', population: '800', zone: 'SWQ', region: 'South West' },
            { id: 'charleville', name: 'Charleville Shire Council', type: 'Shire', population: '3.5K', zone: 'SWQ', region: 'South West' },
            { id: 'roma', name: 'Roma Shire Council', type: 'Shire', population: '7K', zone: 'SWQ', region: 'Darling Downs' },
            { id: 'booringa', name: 'Booringa Shire Council', type: 'Shire', population: '3K', zone: 'SWQ', region: 'Darling Downs' },
            { id: 'warroo', name: 'Warroo Shire Council', type: 'Shire', population: '1K', zone: 'SWQ', region: 'Darling Downs' },
            { id: 'bendemere', name: 'Bendemere Shire Council', type: 'Shire', population: '1.5K', zone: 'SWQ', region: 'Darling Downs' },
            { id: 'boomi', name: 'Boomi Shire Council', type: 'Shire', population: '600', zone: 'SWQ', region: 'Darling Downs' },
            { id: 'tara', name: 'Tara Shire Council', type: 'Shire', population: '3K', zone: 'SWQ', region: 'Darling Downs' },
            { id: 'waggamba', name: 'Waggamba Shire Council', type: 'Shire', population: '3.5K', zone: 'SWQ', region: 'Darling Downs' },

            // FAR NORTH & GULF QUEENSLAND (FWQ) - 19 LGAs
            { id: 'torres', name: 'Torres Shire Council', type: 'Shire', population: '4K', zone: 'FWQ', region: 'Torres Strait' },
            { id: 'torresstraitisland', name: 'Torres Strait Island Regional Council', type: 'Regional', population: '4.5K', zone: 'FWQ', region: 'Torres Strait' },
            { id: 'northernpeninsula', name: 'Northern Peninsula Area Regional Council', type: 'Regional', population: '3K', zone: 'FWQ', region: 'Cape York' },
            { id: 'aurukun', name: 'Aurukun Shire Council', type: 'Shire', population: '1.5K', zone: 'FWQ', region: 'Cape York' },
            { id: 'cook', name: 'Cook Shire Council', type: 'Shire', population: '4K', zone: 'FWQ', region: 'Cape York' },
            { id: 'croydon', name: 'Croydon Shire Council', type: 'Shire', population: '300', zone: 'FWQ', region: 'Gulf' },
            { id: 'etheridge', name: 'Etheridge Shire Council', type: 'Shire', population: '900', zone: 'FWQ', region: 'Gulf' },
            { id: 'hopevale', name: 'Hope Vale Aboriginal Shire Council', type: 'Aboriginal Shire', population: '1K', zone: 'FWQ', region: 'Cape York' },
            { id: 'kowanyama', name: 'Kowanyama Aboriginal Shire Council', type: 'Aboriginal Shire', population: '1K', zone: 'FWQ', region: 'Cape York' },
            { id: 'lockhartriver', name: 'Lockhart River Aboriginal Shire Council', type: 'Aboriginal Shire', population: '700', zone: 'FWQ', region: 'Cape York' },
            { id: 'mapoon', name: 'Mapoon Aboriginal Shire Council', type: 'Aboriginal Shire', population: '400', zone: 'FWQ', region: 'Cape York' },
            { id: 'mornington', name: 'Mornington Shire Council', type: 'Shire', population: '1.2K', zone: 'FWQ', region: 'Gulf' },
            { id: 'napranum', name: 'Napranum Aboriginal Shire Council', type: 'Aboriginal Shire', population: '1K', zone: 'FWQ', region: 'Cape York' },
            { id: 'pormpuraaw', name: 'Pormpuraaw Aboriginal Shire Council', type: 'Aboriginal Shire', population: '700', zone: 'FWQ', region: 'Cape York' },
            { id: 'carpentaria', name: 'Carpentaria Shire Council', type: 'Shire', population: '2K', zone: 'FWQ', region: 'Gulf' },
            { id: 'burke', name: 'Burke Shire Council', type: 'Shire', population: '400', zone: 'FWQ', region: 'Gulf' },
            { id: 'doomadgee', name: 'Doomadgee Aboriginal Shire Council', type: 'Aboriginal Shire', population: '1.5K', zone: 'FWQ', region: 'Gulf' },
            { id: 'mckinlay', name: 'McKinlay Shire Council', type: 'Shire', population: '900', zone: 'FWQ', region: 'North West' },
            { id: 'richmond', name: 'Richmond Shire Council', type: 'Shire', population: '800', zone: 'FWQ', region: 'North West' },
            { id: 'flinders', name: 'Flinders Shire Council', type: 'Shire', population: '1.5K', zone: 'FWQ', region: 'North West' }
        ];

        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyACeeQF5c4sKwQxM4LaW4pzlPd7R5HuRSg",
            authDomain: "queensland-business-reporting.firebaseapp.com",
            projectId: "queensland-business-reporting",
            storageBucket: "queensland-business-reporting.firebasestorage.app",
            messagingSenderId: "271437640355",
            appId: "1:271437640355:web:d11f19e2b61c30d5bd8516",
            measurementId: "G-XE0LCMYLC5"
        };

        let db = null;
        let auth = null;
        let isOnline = navigator.onLine;
        let currentUser = null;
        let isDemoMode = false;
        let isAdmin = false;
        let unsubscribe = null;
        let currentZone = 'all';
        let currentMainTab = 'tenders';

        // Initialize Firebase only if properly configured
        function initializeFirebase() {
            try {
                if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY") {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    auth = firebase.auth();
                    
                    db.enablePersistence({ synchronizeTabs: true })
                        .catch(err => console.log("Persistence failed:", err));
                    
                    return true;
                }
            } catch (e) {
                console.log("Firebase initialization failed:", e);
            }
            return false;
        }

        const firebaseInitialized = initializeFirebase();

        let database = { 
            tenders: [], 
            crmContacts: [],
            interactions: []
        };
        let currentRegion = 'brisbane';

        // ==================== AUTHENTICATION & DEMO MODE ====================
        
        // Add this function for emergency admin access
function emergencyAdminLogin() {
    currentUser = { 
        email: 'james.s.gray1992@gmail.com', 
        uid: 'admin-emergency-' + Date.now() 
    };
    isDemoMode = false;
    isAdmin = true;
    
    document.getElementById('authModal').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('userEmail').textContent = 'Admin (Emergency)';
    document.getElementById('demoBadge').classList.add('hidden');
    document.getElementById('adminButton').classList.remove('hidden');
    
    initializeApp();
    showToast('Emergency admin access granted', 'warning');
}

function enterDemoMode() {
            isDemoMode = true;
            currentUser = { email: 'Demo User', uid: 'demo-' + Date.now() };
            
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userEmail').textContent = 'Demo Mode';
            document.getElementById('demoBadge').classList.remove('hidden');
            
            const saved = localStorage.getItem('qldBusinessData_demo_v2');
            if (saved) {
                try {
                    database = JSON.parse(saved);
                    showToast('Loaded your saved demo data', 'success');
                } catch (e) {
                    loadSampleData();
                }
            } else {
                loadSampleData();
            }
            
            initializeApp();
            showToast('Demo mode active - Data saves to this browser only', 'info');
        }

        // FIXED: Check if admin function - MOVED TO TOP LEVEL
        async function checkIfAdmin() {
            if (!currentUser) {
                console.log('No current user');
                return false;
            }
            // Check if current user is admin
            isAdmin = currentUser.email === "james.s.gray1992@gmail.com";
            console.log('Admin check:', currentUser.email, 'Is admin:', isAdmin);
            return isAdmin;
        }

        // FIXED: Properly structured initializeApp function
        async function initializeApp() {
            console.log('Initializing app...');
            
            // Check if admin and show button FIRST
            if (await checkIfAdmin()) {
                console.log('Showing admin button');
                document.getElementById('adminButton').classList.remove('hidden');
            } else {
                console.log('Hiding admin button');
                document.getElementById('adminButton').classList.add('hidden');
            }
            
            renderRegionTabs();
            populateCRMRegionSelect();
            
            if (!isDemoMode && db && currentUser) {
                setupRealtimeSync();
            } else {
                if (!isDemoMode) loadSampleData();
                loadRegion(currentRegion);
                updateAllStats();
            }
            
            window.addEventListener('online', () => {
                isOnline = true;
                document.getElementById('offlineBanner').classList.remove('show');
                showToast('Back online', 'success');
                updateSyncStatus(isDemoMode ? 'Demo Mode' : 'Synced');
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                document.getElementById('offlineBanner').classList.add('show');
                updateSyncStatus('Offline');
            });
        }

       // Auth state observer
// Auth state observer
if (firebaseInitialized && auth) {
    auth.onAuthStateChanged(async user => {
        console.log('Auth state changed:', user ? user.email : 'null');
        
        if (user) {
            // Check if email is verified
            if (!user.emailVerified) {
                showToast('Please verify your email before continuing. Check your inbox.', 'warning');
                await auth.signOut();
                
                // Show verification message
                document.getElementById('authForm').innerHTML = `
                    <div class="text-center">
                        <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600 text-2xl mx-auto mb-4">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <h3 class="text-lg font-bold mb-2">Verify Your Email</h3>
                        <p class="text-gray-600 mb-4">We've sent a verification link to ${user.email}. Please check your inbox and click the link.</p>
                        <button onclick="resendVerificationEmail('${user.email}')" class="w-full py-2 bg-blue-600 text-white rounded-lg mb-2 hover:bg-blue-700">
                            Resend Email
                        </button>
                        <button onclick="location.reload()" class="w-full py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                            I've Verified - Continue
                        </button>
                    </div>
                `;
                return;
            }
            
            // BYPASS APPROVAL FOR ADMIN EMAIL
            if (user.email === "james.s.gray1992@gmail.com") {
                console.log('Admin user detected, bypassing approval check');
                
                // Auto-approve admin in the database
                try {
                    await db.collection('approvedUsers').doc(user.uid).set({
                        email: user.email,
                        approved: true,
                        approvedAt: new Date().toISOString(),
                        approvedBy: 'system'
                    });
                } catch (e) {
                    console.log('Could not write approval doc, continuing anyway:', e);
                }
                
                // Grant access immediately
                currentUser = user;
                isDemoMode = false;
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('demoBadge').classList.add('hidden');
                
                await initializeApp();
                showToast('Welcome Admin!', 'success');
                return;
            }
            
            // For non-admin users, check approval
            try {
                const approvalDoc = await db.collection('approvedUsers').doc(user.uid).get();
                
                if (!approvalDoc.exists || !approvalDoc.data().approved) {
                    showToast('Your account is pending admin approval.', 'warning');
                    await auth.signOut();
                    
                    // Show pending approval message
                    document.getElementById('authForm').innerHTML = `
                        <div class="text-center">
                            <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 text-2xl mx-auto mb-4">
                                <i class="fas fa-clock"></i>
                            </div>
                            <h3 class="text-lg font-bold mb-2">Pending Approval</h3>
                            <p class="text-gray-600 mb-4">Your email is verified, but an administrator must approve your account.</p>
                            <p class="text-sm text-gray-500 mb-4">Approval request sent for: <strong>${user.email}</strong></p>
                            <button onclick="checkApprovalStatus('${user.uid}')" class="w-full py-2 bg-[#771414] text-white rounded-lg mb-2 hover:bg-[#5a1010]">
                                Check Status
                            </button>
                            <button onclick="location.reload()" class="w-full py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                Back to Login
                            </button>
                        </div>
                    `;
                    
                    // Create approval request
                    await db.collection('approvalRequests').doc(user.uid).set({
                        email: user.email,
                        requestedAt: new Date().toISOString(),
                        status: 'pending',
                        uid: user.uid
                    });
                    
                    return;
                }
                
                // User is approved - grant access
                currentUser = user;
                isDemoMode = false;
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('demoBadge').classList.add('hidden');
                
                await initializeApp();
                showToast('Welcome! Account approved.', 'success');
                
            } catch (err) {
                console.error("Approval check failed:", err);
                showToast('Error checking approval status.', 'error');
                await auth.signOut();
            }
            
        } else if (!isDemoMode) {
            resetAuthForm();
            document.getElementById('authModal').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
    });
}

        function resetAuthForm() {
            document.getElementById('authForm').innerHTML = `
                <input type="email" id="authEmail" placeholder="Email address" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 mb-3 focus:border-[#771414] focus:outline-none">
                <input type="password" id="authPassword" placeholder="Password" class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 mb-4 focus:border-[#771414] focus:outline-none">
                
                <button onclick="signIn()" class="w-full py-3 bg-[#771414] text-white rounded-lg font-medium hover:bg-[#5a1010] transition-colors mb-3">
                    Sign In
                </button>
                
                <button onclick="signUp()" class="w-full py-3 border-2 border-[#771414] text-[#771414] rounded-lg font-medium hover:bg-red-50 transition-colors mb-4">
                    Create Account
                </button>
                
                <div class="relative mb-4">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">or</span>
                    </div>
                </div>
                
                <button onclick="enterDemoMode()" class="w-full py-3 bg-gray-800 text-white rounded-lg font-medium hover:bg-gray-900 transition-colors flex items-center justify-center">
                    <i class="fas fa-play-circle mr-2"></i> Continue in Demo Mode
                </button>
                
                <p class="text-xs text-center text-gray-400 mt-4">
                    Demo mode stores data locally on your device. No account required.
                </p>
            `;
        }

        async function resendVerificationEmail() {
            const user = auth.currentUser;
            if (!user) {
                showToast('Session expired. Please sign in again.', 'error');
                signOutAndReset();
                return;
            }
            
            try {
                await user.sendEmailVerification();
                showToast('Verification email resent! Check your inbox.', 'success');
            } catch (err) {
                console.error('Resend error:', err);
                if (err.code === 'auth/too-many-requests') {
                    showToast('Too many requests. Please wait a few minutes.', 'warning');
                } else {
                    showToast('Error: ' + err.message, 'error');
                }
}
        }
async function checkVerificationAndContinue() {
    try {
        await auth.currentUser.reload();
        const refreshedUser = auth.currentUser;
        
        if (refreshedUser.emailVerified) {
            showToast('Email verified! Continuing...', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showToast('Email not yet verified. Please check your inbox and click the link.', 'warning');
        }
    } catch (err) {
        showToast('Error checking verification status', 'error');
    }
}

function signOutAndReset() {
    auth.signOut().then(() => {
        resetAuthForm();
        document.getElementById('authModal').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
    });
}

        async function checkApprovalStatus(uid) {
            try {
                const doc = await db.collection('approvedUsers').doc(uid).get();
                if (doc.exists && doc.data().approved) {
                    showToast('You have been approved! Please sign in again.', 'success');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    showToast('Still pending approval. Please check back later or contact admin.', 'warning');
                }
            } catch (err) {
                showToast('Error checking status', 'error');
            }
        }

        function signIn() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            if (auth) {
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => {
                        showToast(error.message, 'error');
                    });
            } else {
                showToast('Firebase not configured. Please use Demo Mode.', 'info');
                setTimeout(enterDemoMode, 1000);
            }
        }

        async function signUp() {
            // ADD THIS TO YOUR SIGN-UP FUNCTION (not in onAuthStateChanged)
async function signUp(email, password) {
    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // SEND VERIFICATION EMAIL IMMEDIATELY AFTER SIGN-UP
        await user.sendEmailVerification();
        console.log('Verification email sent to:', email);
        
        showToast('Account created! Please check your email to verify.', 'success');
        
        // Sign out immediately so they can't access until verified
        await auth.signOut();
        
        // Show verification UI
        document.getElementById('authForm').innerHTML = `
            <div class="text-center">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600 text-2xl mx-auto mb-4">
                    <i class="fas fa-envelope"></i>
                </div>
                <h3 class="text-lg font-bold mb-2">Verify Your Email</h3>
                <p class="text-gray-600 mb-4">We've sent a verification link to ${email}. Please check your inbox.</p>
                <button onclick="resendVerificationEmail('${email}')" class="w-full py-2 bg-blue-600 text-white rounded-lg mb-2 hover:bg-blue-700">
                    Resend Email
                </button>
                <button onclick="location.reload()" class="w-full py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                    Back to Login
                </button>
            </div>
        `;
        
    } catch (error) {
        console.error('Sign up error:', error);
        showToast(error.message, 'error');
    }
}

// RESEND FUNCTION (keep this separate)
async function resendVerificationEmail(email) {
    try {
        // User must be signed in to resend
        const user = auth.currentUser;
        if (user && !user.emailVerified) {
            await user.sendEmailVerification();
            showToast('Verification email resent!', 'success');
        } else {
            showToast('Please sign in first to resend verification.', 'warning');
        }
    } catch (error) {
        console.error('Resend error:', error);
        showToast('Error resending email. Please try again later.', 'error');
    }
}
const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }

            if (auth) {
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    
                    // Send verification email immediately
                    await userCredential.user.sendEmailVerification();
                    
                    showToast('Account created! Please verify your email.', 'success');
                    
                    // Show verification waiting screen
                    document.getElementById('authForm').innerHTML = `
                        <div class="text-center">
                            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-2xl mx-auto mb-4">
                                <i class="fas fa-envelope-open-text"></i>
                            </div>
                            <h3 class="text-lg font-bold mb-2">Verify Your Email</h3>
                            <p class="text-gray-600 mb-4">We've sent a verification link to <strong>${email}</strong>.</p>
                            <p class="text-sm text-gray-500 mb-4">After verifying, an administrator must approve your account before you can access the system.</p>
                            <button onclick="resendVerificationEmail('${email}')" class="w-full py-2 bg-blue-600 text-white rounded-lg mb-2 hover:bg-blue-700">
                                Resend Verification Email
                            </button>
                            <button onclick="location.reload()" class="w-full py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                                Back to Login
                            </button>
                        </div>
                    `;
                    
                } catch (error) {
                    showToast(error.message, 'error');
                }
            } else {
                showToast('Cannot create account - Firebase not configured', 'error');
                setTimeout(enterDemoMode, 1000);
            }
        }

        function signOut() {
            if (isDemoMode) {
                if (confirm('Sign out of Demo Mode? Your data will remain saved in this browser.')) {
                    isDemoMode = false;
                    currentUser = null;
                    isAdmin = false;
                    document.getElementById('adminButton').classList.add('hidden');
                    document.getElementById('authModal').classList.remove('hidden');
                    document.getElementById('mainApp').classList.add('hidden');
                    document.getElementById('demoBadge').classList.add('hidden');
                    resetAuthForm();
                }
            } else if (auth) {
                auth.signOut();
                isAdmin = false;
                document.getElementById('adminButton').classList.add('hidden');
                resetAuthForm();
            }
        }

        function setupRealtimeSync() {
            const userDoc = db.collection('users').doc(currentUser.uid);
            
            unsubscribe = userDoc.onSnapshot(doc => {
                if (doc.exists) {
                    database = doc.data();
                } else {
                    userDoc.set({ tenders: [], crmContacts: [], interactions: [] });
                }
                loadRegion(currentRegion);
                updateAllStats();
                updateSyncStatus('Synced');
            }, err => {
                console.error("Sync error:", err);
                updateSyncStatus('Error');
            });
        }

        function loadSampleData() {
            database = {
                tenders: [
                    {
                        id: 1,
                        regionId: 'brisbane',
                        title: 'Road Infrastructure Upgrade - Northern Suburbs',
                        category: 'Infrastructure',
                        value: '$2.5M',
                        status: 'TO_PRICE',
                        closingDate: '2024-12-15',
                        description: 'Major road resurfacing and intersection improvements.',
                        contact: { name: 'Sarah Mitchell', position: 'Senior Procurement Officer', email: 's.mitchell@brisbane.qld.gov.au', phone: '(07) 3403 8888' },
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 2,
                        regionId: 'goldcoast',
                        title: 'Beachfront Revitalisation Project',
                        category: 'Construction',
                        value: '$8M',
                        status: 'PRICED',
                        closingDate: '2024-12-20',
                        ourPrice: '$7.8M',
                        submissionDate: '2024-12-18',
                        description: 'Boardwalk reconstruction and beach amenity upgrades.',
                        contact: { name: 'James Chen', position: 'Infrastructure Manager', email: 'j.chen@goldcoast.qld.gov.au', phone: '(07) 5581 6984' },
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 3,
                        regionId: 'townsville',
                        title: 'Water Treatment Plant Upgrade',
                        category: 'Water & Sewerage',
                        value: '$12M',
                        status: 'NOT_WON',
                        closingDate: '2024-11-30',
                        ourLosingPrice: '$11.5M',
                        winnerName: 'AquaTech Solutions Pty Ltd',
                        winnerPrice: '$10.8M',
                        resultDate: '2024-12-05',
                        notWonComments: 'Lost on price. Competitor had existing relationship with council. Recommend building relationship with operations team before next tender.',
                        description: 'Upgrade of main water treatment facility.',
                        contact: { name: 'Michael Torres', position: 'Water Operations Manager', email: 'm.torres@townsville.qld.gov.au', phone: '(07) 4727 9680' },
                        createdAt: new Date().toISOString()
                    }
                ],
                crmContacts: [
                    {
                        id: 1,
                        regionId: 'brisbane',
                        name: 'Sarah Mitchell',
                        position: 'Senior Procurement Officer',
                        department: 'Infrastructure & Transport',
                        type: 'Procurement',
                        email: 's.mitchell@brisbane.qld.gov.au',
                        directPhone: '(07) 3403 8888',
                        mobile: '0400 123 456',
                        notes: 'Prefers email contact. Interested in sustainable construction methods.',
                        lastContactDate: '2024-02-15',
                        lastContactType: 'Meeting',
                        lastContactNotes: 'Discussed upcoming road infrastructure projects for Q2 2024.',
                        followUpDate: '2024-03-15',
                        priority: 'High',
                        interactions: []
                    }
                ],
                interactions: []
            };
        }

        // ==================== MAIN TAB SWITCHING ====================
        
        function switchMainTab(tab) {
            currentMainTab = tab;
            
            // Update tab styles
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            
            // Show/hide content
            document.querySelectorAll('.main-content').forEach(c => c.classList.add('hidden'));
            document.getElementById('content-' + tab).classList.remove('hidden');
            
            // Refresh content
            if (tab === 'tenders') {
                loadRegion(currentRegion);
            } else if (tab === 'crm') {
                renderCRMContacts();
            } else if (tab === 'analytics') {
                renderAnalytics();
            }
        }

        // ==================== REGION & TENDER FUNCTIONS ====================
        
        function filterByZone(zone) {
            currentZone = zone;
            
            document.querySelectorAll('.zone-filter').forEach(btn => {
                if (btn.dataset.zone === zone) {
                    btn.className = 'zone-filter px-4 py-2 rounded-full text-sm font-medium bg-[#771414] text-white shadow-md transition-all';
                } else {
                    btn.className = 'zone-filter px-4 py-2 rounded-full text-sm font-medium bg-white text-gray-600 hover:bg-gray-100 border border-gray-200 transition-all';
                }
            });
            
            renderRegionTabs();
            
            const visibleRegions = getVisibleRegions();
            if (visibleRegions.length > 0 && !visibleRegions.find(r => r.id === currentRegion)) {
                loadRegion(visibleRegions[0].id);
            }
        }

        function getVisibleRegions() {
            if (currentZone === 'all') return qldRegions;
            return qldRegions.filter(r => r.zone === currentZone);
        }

        function renderRegionTabs() {
            const container = document.getElementById('regionTabs');
            const regions = getVisibleRegions();
            
            container.innerHTML = regions.map(region => `
                <button onclick="loadRegion('${region.id}')" 
                        class="region-tab m-1 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap ${region.id === currentRegion ? 'bg-[#771414] text-white shadow-md' : 'bg-white text-gray-600 hover:bg-gray-50 border border-gray-200'}"
                        data-region="${region.id}"
                        title="${region.name} - ${region.region}">
                    <div class="flex flex-col items-start">
                        <span class="font-semibold truncate max-w-[200px]">${region.name.replace(' Council', '').replace(' Shire', '')}</span>
                        <span class="text-xs opacity-75">${region.region}</span>
                    </div>
                </button>
            `).join('');
        }

        function loadRegion(regionId) {
            currentRegion = regionId;
            
            document.querySelectorAll('.region-tab').forEach(tab => {
                if(tab.dataset.region === regionId) {
                    tab.className = 'region-tab m-1 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap bg-[#771414] text-white shadow-md';
                } else {
                    tab.className = 'region-tab m-1 px-4 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap bg-white text-gray-600 hover:bg-gray-50 border border-gray-200';
                }
            });

            const region = qldRegions.find(r => r.id === regionId);
            
            document.getElementById('regionContent').innerHTML = `
                <div class="glass-panel rounded-2xl p-6 mb-6 border-l-4 border-[#771414]">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded font-medium">${region.zone}</span>
                                <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">${region.region}</span>
                                <span class="px-2 py-1 bg-[#771414] bg-opacity-10 text-[#771414] text-xs rounded font-medium">${region.type}</span>
                            </div>
                            <h2 class="text-2xl font-bold display-font text-gray-900">${region.name}</h2>
                            <p class="text-gray-500 mt-1">Population: ${region.population}</p>
                        </div>
                        <div class="flex space-x-3 mt-4 md:mt-0">
                            <button onclick="showAddTenderModal()" class="px-4 py-2 bg-[#771414] text-white rounded-lg hover:bg-[#5a1010] transition-colors shadow-md text-sm font-medium">
                                <i class="fas fa-plus mr-2"></i> Add Tender
                            </button>
                        </div>
                    </div>
                </div>

                <div class="space-y-6">
                    <!-- TO PRICE Section -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-blue-50 px-6 py-4 border-b border-blue-100 flex justify-between items-center">
                            <h3 class="font-bold text-blue-900 flex items-center">
                                <i class="fas fa-calculator mr-2"></i> TO PRICE
                                <span class="ml-2 bg-blue-200 text-blue-800 text-xs px-2 py-1 rounded-full">${database.tenders.filter(t => t.regionId === regionId && t.status === 'TO_PRICE').length}</span>
                            </h3>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${renderTendersByStatus(regionId, 'TO_PRICE')}
                        </div>
                    </div>

                    <!-- PRICED Section -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-green-50 px-6 py-4 border-b border-green-100 flex justify-between items-center">
                            <h3 class="font-bold text-green-900 flex items-center">
                                <i class="fas fa-check-circle mr-2"></i> PRICED
                                <span class="ml-2 bg-green-200 text-green-800 text-xs px-2 py-1 rounded-full">${database.tenders.filter(t => t.regionId === regionId && t.status === 'PRICED').length}</span>
                            </h3>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${renderTendersByStatus(regionId, 'PRICED')}
                        </div>
                    </div>

                    <!-- NOT PRICING Section -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                            <h3 class="font-bold text-gray-900 flex items-center">
                                <i class="fas fa-ban mr-2"></i> NOT PRICING
                                <span class="ml-2 bg-gray-200 text-gray-800 text-xs px-2 py-1 rounded-full">${database.tenders.filter(t => t.regionId === regionId && t.status === 'NOT_PRICING').length}</span>
                            </h3>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${renderTendersByStatus(regionId, 'NOT_PRICING')}
                        </div>
                    </div>

                    <!-- AWARDED Section -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-yellow-50 px-6 py-4 border-b border-yellow-100 flex justify-between items-center">
                            <h3 class="font-bold text-yellow-900 flex items-center">
                                <i class="fas fa-trophy mr-2"></i> AWARDED
                                <span class="ml-2 bg-yellow-200 text-yellow-800 text-xs px-2 py-1 rounded-full">${database.tenders.filter(t => t.regionId === regionId && t.status === 'AWARDED').length}</span>
                            </h3>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${renderTendersByStatus(regionId, 'AWARDED')}
                        </div>
                    </div>

                    <!-- NOT WON Section -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                        <div class="bg-red-50 px-6 py-4 border-b border-red-100 flex justify-between items-center">
                            <h3 class="font-bold text-red-900 flex items-center">
                                <i class="fas fa-times-circle mr-2"></i> NOT WON
                                <span class="ml-2 bg-red-200 text-red-800 text-xs px-2 py-1 rounded-full">${database.tenders.filter(t => t.regionId === regionId && t.status === 'NOT_WON').length}</span>
                            </h3>
                        </div>
                        <div class="p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${renderTendersByStatus(regionId, 'NOT_WON')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTendersByStatus(regionId, status) {
            const tenders = database.tenders.filter(t => t.regionId === regionId && t.status === status);
            
            if (tenders.length === 0) {
                return `<div class="col-span-full text-center py-8 text-gray-400 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                    <i class="fas fa-inbox text-3xl mb-2"></i>
                    <p class="text-sm">No tenders in this category</p>
                </div>`;
            }
            
            return tenders.map(tender => {
                const daysLeft = tender.closingDate ? Math.ceil((new Date(tender.closingDate) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                
                let statusBadge = '';
                let cardClass = '';
                
                switch(status) {
                    case 'TO_PRICE':
                        statusBadge = '<span class="status-to-price text-xs font-bold px-2 py-1 rounded">TO PRICE</span>';
                        cardClass = 'border-l-4 border-blue-500';
                        break;
                    case 'PRICED':
                        statusBadge = '<span class="status-priced text-xs font-bold px-2 py-1 rounded">PRICED</span>';
                        cardClass = 'border-l-4 border-green-500';
                        break;
                    case 'NOT_PRICING':
                        statusBadge = '<span class="status-not-pricing text-xs font-bold px-2 py-1 rounded">NOT PRICING</span>';
                        cardClass = 'border-l-4 border-gray-400';
                        break;
                    case 'AWARDED':
                        statusBadge = '<span class="bg-yellow-100 text-yellow-800 text-xs font-bold px-2 py-1 rounded">AWARDED</span>';
                        cardClass = 'border-l-4 border-yellow-500';
                        break;
                    case 'NOT_WON':
                        statusBadge = '<span class="bg-red-100 text-red-800 text-xs font-bold px-2 py-1 rounded">NOT WON</span>';
                        cardClass = 'not-won-card';
                        break;
                }
                
                let extraInfo = '';
                if (status === 'PRICED' && tender.ourPrice) {
                    extraInfo = `<div class="text-sm text-green-700 font-semibold"><i class="fas fa-tag mr-1"></i> Our Price: ${tender.ourPrice}</div>`;
                } else if (status === 'NOT_PRICING' && tender.notPricingReason) {
                    extraInfo = `<div class="text-sm text-gray-600"><i class="fas fa-info-circle mr-1"></i> ${tender.notPricingReason}</div>`;
                } else if (status === 'AWARDED' && tender.awardedValue) {
                    extraInfo = `<div class="text-sm text-yellow-700 font-semibold"><i class="fas fa-trophy mr-1"></i> Won: ${tender.awardedValue}</div>`;
                } else if (status === 'NOT_WON' && tender.winnerName) {
                    extraInfo = `<div class="text-sm text-red-700"><i class="fas fa-building mr-1"></i> Winner: ${tender.winnerName}</div>
                                 ${tender.winnerPrice ? `<div class="text-sm text-gray-600">Their price: ${tender.winnerPrice}</div>` : ''}`;
                }
                
                return `
                <div class="bg-white rounded-lg p-4 shadow-sm ${cardClass} card-hover cursor-pointer" onclick="editTender(${tender.id})">
                    <div class="flex justify-between items-start mb-2">
                        ${statusBadge}
                        ${daysLeft && daysLeft <= 7 && daysLeft > 0 ? '<span class="text-xs font-bold text-red-600 bg-red-50 px-2 py-1 rounded animate-pulse">CLOSING SOON</span>' : ''}
                    </div>
                    <h4 class="font-bold text-gray-900 mb-2 line-clamp-2">${tender.title}</h4>
                    <div class="space-y-1 text-sm text-gray-600 mb-2">
                        <div><i class="fas fa-dollar-sign w-4 text-gray-400"></i> ${tender.value || 'N/A'}</div>
                        ${tender.closingDate ? `<div><i class="fas fa-calendar w-4 text-gray-400"></i> ${formatDate(tender.closingDate)} ${daysLeft ? `(${daysLeft} days)` : ''}</div>` : ''}
                    </div>
                    ${extraInfo}
                    <div class="mt-3 pt-2 border-t border-gray-100 text-xs text-gray-500">
                        <i class="fas fa-user mr-1"></i> ${tender.contact?.name || 'No contact'}
                    </div>
                </div>
                `;
            }).join('');
        }

        // ==================== TENDER MODAL FUNCTIONS ====================
        
        function showAddTenderModal() {
            document.getElementById('tenderModalTitle').textContent = 'Add New Tender';
            document.getElementById('tenderId').value = '';
            document.getElementById('tenderRegion').value = currentRegion;
            document.getElementById('tenderForm').reset();
            togglePricingFields();
            document.getElementById('tenderModal').classList.remove('hidden');
        }

        function editTender(id) {
            const tender = database.tenders.find(t => t.id === id);
            if (!tender) return;
            
            document.getElementById('tenderModalTitle').textContent = 'Edit Tender';
            document.getElementById('tenderId').value = id;
            document.getElementById('tenderRegion').value = tender.regionId;
            document.getElementById('tenderTitle').value = tender.title;
            document.getElementById('tenderCategory').value = tender.category;
            document.getElementById('tenderStatus').value = tender.status;
            document.getElementById('tenderValue').value = tender.value;
            document.getElementById('tenderClosingDate').value = tender.closingDate;
            document.getElementById('tenderDescription').value = tender.description || '';
            
            // Contact
            document.getElementById('tenderContactName').value = tender.contact?.name || '';
            document.getElementById('tenderContactPosition').value = tender.contact?.position || '';
            document.getElementById('tenderContactEmail').value = tender.contact?.email || '';
            document.getElementById('tenderContactPhone').value = tender.contact?.phone || '';
            
            // Status-specific fields
            if (tender.status === 'PRICED') {
                document.getElementById('ourPrice').value = tender.ourPrice || '';
                document.getElementById('submissionDate').value = tender.submissionDate || '';
            } else if (tender.status === 'NOT_PRICING') {
                document.getElementById('notPricingReason').value = tender.notPricingReason || '';
                document.getElementById('notPricingComments').value = tender.notPricingComments || '';
            } else if (tender.status === 'AWARDED') {
                document.getElementById('awardedDate').value = tender.awardedDate || '';
                document.getElementById('awardedValue').value = tender.awardedValue || '';
                document.getElementById('awardedScope').value = tender.awardedScope || '';
            } else if (tender.status === 'NOT_WON') {
                document.getElementById('winnerName').value = tender.winnerName || '';
                document.getElementById('winnerPrice').value = tender.winnerPrice || '';
                document.getElementById('ourLosingPrice').value = tender.ourLosingPrice || '';
                document.getElementById('resultDate').value = tender.resultDate || '';
                document.getElementById('notWonComments').value = tender.notWonComments || '';
            }
            
            togglePricingFields();
            document.getElementById('tenderModal').classList.remove('hidden');
        }

        function togglePricingFields() {
            const status = document.getElementById('tenderStatus').value;
            
            document.getElementById('pricedFields').classList.add('hidden');
            document.getElementById('notPricingFields').classList.add('hidden');
            document.getElementById('awardedFields').classList.add('hidden');
            document.getElementById('notWonFields').classList.add('hidden');
            
            if (status === 'PRICED') {
                document.getElementById('pricedFields').classList.remove('hidden');
            } else if (status === 'NOT_PRICING') {
                document.getElementById('notPricingFields').classList.remove('hidden');
            } else if (status === 'AWARDED') {
                document.getElementById('awardedFields').classList.remove('hidden');
            } else if (status === 'NOT_WON') {
                document.getElementById('notWonFields').classList.remove('hidden');
            }
        }

        function closeTenderModal() {
            document.getElementById('tenderModal').classList.add('hidden');
        }

        document.getElementById('tenderForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('tenderId').value;
            const regionId = document.getElementById('tenderRegion').value;
            const status = document.getElementById('tenderStatus').value;
            
            const tenderData = {
                title: document.getElementById('tenderTitle').value,
                category: document.getElementById('tenderCategory').value,
                status: status,
                value: document.getElementById('tenderValue').value,
                closingDate: document.getElementById('tenderClosingDate').value,
                description: document.getElementById('tenderDescription').value,
                contact: {
                    name: document.getElementById('tenderContactName').value,
                    position: document.getElementById('tenderContactPosition').value,
                    email: document.getElementById('tenderContactEmail').value,
                    phone: document.getElementById('tenderContactPhone').value
                },
                updatedAt: new Date().toISOString()
            };
            
            // Add status-specific fields
            if (status === 'PRICED') {
                tenderData.ourPrice = document.getElementById('ourPrice').value;
                tenderData.submissionDate = document.getElementById('submissionDate').value;
            } else if (status === 'NOT_PRICING') {
                tenderData.notPricingReason = document.getElementById('notPricingReason').value;
                tenderData.notPricingComments = document.getElementById('notPricingComments').value;
            } else if (status === 'AWARDED') {
                tenderData.awardedDate = document.getElementById('awardedDate').value;
                tenderData.awardedValue = document.getElementById('awardedValue').value;
                tenderData.awardedScope = document.getElementById('awardedScope').value;
            } else if (status === 'NOT_WON') {
                tenderData.winnerName = document.getElementById('winnerName').value;
                tenderData.winnerPrice = document.getElementById('winnerPrice').value;
                tenderData.ourLosingPrice = document.getElementById('ourLosingPrice').value;
                tenderData.resultDate = document.getElementById('resultDate').value;
                tenderData.notWonComments = document.getElementById('notWonComments').value;
            }
            
            if (id) {
                const index = database.tenders.findIndex(t => t.id == id);
                if (index !== -1) {
                    database.tenders[index] = { ...database.tenders[index], ...tenderData };
                }
            } else {
                tenderData.id = Date.now();
                tenderData.regionId = regionId;
                tenderData.createdAt = new Date().toISOString();
                database.tenders.push(tenderData);
            }
            
            await saveData();
            closeTenderModal();
            loadRegion(currentRegion);
            updateAllStats();
            showToast('Tender saved successfully!', 'success');
        });

        // ==================== CRM FUNCTIONS ====================
        
        function populateCRMRegionSelect() {
            const select = document.getElementById('crmRegion');
            const filter = document.getElementById('crmRegionFilter');
            
            const options = qldRegions.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            
            if (select) select.innerHTML = '<option value="">Select Region...</option>' + options;
            if (filter) filter.innerHTML = '<option value="all">All Regions</option>' + options;
        }

        function renderCRMContacts() {
            const searchTerm = document.getElementById('crmSearch')?.value?.toLowerCase() || '';
            const regionFilter = document.getElementById('crmRegionFilter')?.value || 'all';
            
            let contacts = database.crmContacts || [];
            
            if (searchTerm) {
                contacts = contacts.filter(c => 
                    c.name.toLowerCase().includes(searchTerm) ||
                    c.position.toLowerCase().includes(searchTerm) ||
                    c.department?.toLowerCase().includes(searchTerm)
                );
            }
            
            if (regionFilter !== 'all') {
                contacts = contacts.filter(c => c.regionId === regionFilter);
            }
            
            const container = document.getElementById('crmContactsList');
            
            if (contacts.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-12 text-gray-400 bg-gray-50 rounded-xl border-2 border-dashed border-gray-200">
                    <i class="fas fa-address-book text-4xl mb-3"></i>
                    <p>No contacts found. Add your first council contact!</p>
                </div>`;
                return;
            }
            
            container.innerHTML = contacts.map(contact => {
                const region = qldRegions.find(r => r.id === contact.regionId);
                const interactions = database.interactions?.filter(i => i.contactId === contact.id) || [];
                
                return `
                <div class="crm-contact-card rounded-xl p-6 shadow-sm card-hover">
                    <div class="flex justify-between items-start mb-4">
                        <div class="flex items-start space-x-3">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-100 to-blue-200 flex items-center justify-center text-blue-700 font-bold text-xl flex-shrink-0">
                                ${contact.name.charAt(0)}
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-900 text-lg">${contact.name}</h4>
                                <p class="text-blue-600 font-medium">${contact.position}</p>
                                <p class="text-sm text-gray-500">${region?.name}</p>
                                <span class="inline-block mt-1 px-2 py-1 bg-blue-50 text-blue-700 text-xs rounded">${contact.type}</span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="showAddInteractionModal(${contact.id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Add Interaction">
                                <i class="fas fa-comment-plus"></i>
                            </button>
                            <button onclick="editCRMContact(${contact.id})" class="p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-2 text-sm mb-4">
                        ${contact.department ? `<div class="text-gray-600"><i class="fas fa-building w-5 text-gray-400"></i> ${contact.department}</div>` : ''}
                        <div class="text-gray-600"><i class="fas fa-envelope w-5 text-gray-400"></i> ${contact.email}</div>
                        ${contact.directPhone ? `<div class="text-gray-600"><i class="fas fa-phone w-5 text-gray-400"></i> ${contact.directPhone}</div>` : ''}
                        ${contact.mobile ? `<div class="text-gray-600"><i class="fas fa-mobile w-5 text-gray-400"></i> ${contact.mobile}</div>` : ''}
                    </div>
                    
                    ${contact.notes ? `<div class="bg-gray-50 rounded-lg p-3 text-sm text-gray-600 mb-4 italic">${contact.notes}</div>` : ''}
                    
                    ${interactions.length > 0 ? `
                    <div class="border-t pt-4">
                        <h5 class="font-semibold text-sm text-gray-700 mb-2">Recent Interactions</h5>
                        <div class="interaction-timeline space-y-3">
                            ${interactions.slice(-3).map((interaction, idx) => `
                                <div class="relative pl-4">
                                    <div class="timeline-dot" style="top: 4px;"></div>
                                    <div class="text-xs text-gray-500">${formatDate(interaction.date)}  ${interaction.type}</div>
                                    <div class="text-sm text-gray-700">${interaction.notes}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${contact.followUpDate && new Date(contact.followUpDate) >= new Date() ? `
                    <div class="mt-4 p-3 bg-orange-50 rounded-lg border border-orange-100 flex items-center text-sm text-orange-800">
                        <i class="fas fa-bell mr-2"></i>
                        Follow-up due: ${formatDate(contact.followUpDate)}
                    </div>
                    ` : ''}
                </div>
                `;
            }).join('');
            
            updateCRMStats();
        }

        function searchCRM() {
            renderCRMContacts();
        }

        function filterCRMByRegion() {
            renderCRMContacts();
        }

        function showAddCRMModal() {
            document.getElementById('crmModalTitle').textContent = 'Add CRM Contact';
            document.getElementById('crmContactId').value = '';
            document.getElementById('crmForm').reset();
            document.getElementById('crmModal').classList.remove('hidden');
        }

        function editCRMContact(id) {
            const contact = database.crmContacts.find(c => c.id === id);
            if (!contact) return;
            
            document.getElementById('crmModalTitle').textContent = 'Edit CRM Contact';
            document.getElementById('crmContactId').value = id;
            document.getElementById('crmRegion').value = contact.regionId;
            document.getElementById('crmType').value = contact.type;
            document.getElementById('crmName').value = contact.name;
            document.getElementById('crmPosition').value = contact.position;
            document.getElementById('crmDepartment').value = contact.department || '';
            document.getElementById('crmDirectPhone').value = contact.directPhone || '';
            document.getElementById('crmMobile').value = contact.mobile || '';
            document.getElementById('crmEmail').value = contact.email;
            document.getElementById('crmLinkedIn').value = contact.linkedIn || '';
            document.getElementById('crmNotes').value = contact.notes || '';
            document.getElementById('crmLastContactDate').value = contact.lastContactDate || '';
            document.getElementById('crmLastContactType').value = contact.lastContactType || '';
            document.getElementById('crmLastContactNotes').value = contact.lastContactNotes || '';
            document.getElementById('crmFollowUpDate').value = contact.followUpDate || '';
            document.getElementById('crmPriority').value = contact.priority || 'Medium';
            
            document.getElementById('crmModal').classList.remove('hidden');
        }

        function closeCRMModal() {
            document.getElementById('crmModal').classList.add('hidden');
        }

        document.getElementById('crmForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const id = document.getElementById('crmContactId').value;
            
            const contactData = {
                regionId: document.getElementById('crmRegion').value,
                type: document.getElementById('crmType').value,
                name: document.getElementById('crmName').value,
                position: document.getElementById('crmPosition').value,
                department: document.getElementById('crmDepartment').value,
                directPhone: document.getElementById('crmDirectPhone').value,
                mobile: document.getElementById('crmMobile').value,
                email: document.getElementById('crmEmail').value,
                linkedIn: document.getElementById('crmLinkedIn').value,
                notes: document.getElementById('crmNotes').value,
                lastContactDate: document.getElementById('crmLastContactDate').value,
                lastContactType: document.getElementById('crmLastContactType').value,
                lastContactNotes: document.getElementById('crmLastContactNotes').value,
                followUpDate: document.getElementById('crmFollowUpDate').value,
                priority: document.getElementById('crmPriority').value,
                updatedAt: new Date().toISOString()
            };
            
            if (id) {
                const index = database.crmContacts.findIndex(c => c.id == id);
                if (index !== -1) {
                    contactData.id = parseInt(id);
                    contactData.interactions = database.crmContacts[index].interactions || [];
                    database.crmContacts[index] = contactData;
                }
            } else {
                contactData.id = Date.now();
                contactData.interactions = [];
                database.crmContacts.push(contactData);
            }
            
            await saveData();
            closeCRMModal();
            renderCRMContacts();
            updateAllStats();
            showToast('Contact saved successfully!', 'success');
        });

        // ==================== INTERACTION FUNCTIONS ====================
        
        function showAddInteractionModal(contactId) {
            document.getElementById('interactionContactId').value = contactId;
            document.getElementById('interactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('interactionForm').reset();
            document.getElementById('interactionModal').classList.remove('hidden');
        }

        function closeInteractionModal() {
            document.getElementById('interactionModal').classList.add('hidden');
        }

        document.getElementById('interactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const contactId = parseInt(document.getElementById('interactionContactId').value);
            
            const interaction = {
                id: Date.now(),
                contactId: contactId,
                date: document.getElementById('interactionDate').value,
                type: document.getElementById('interactionType').value,
                notes: document.getElementById('interactionNotes').value,
                nextSteps: document.getElementById('interactionNextSteps').value,
                createdAt: new Date().toISOString()
            };
            
            if (!database.interactions) database.interactions = [];
            database.interactions.push(interaction);
            
            // Update contact's last contact info
            const contact = database.crmContacts.find(c => c.id === contactId);
            if (contact) {
                contact.lastContactDate = interaction.date;
                contact.lastContactType = interaction.type;
                contact.lastContactNotes = interaction.notes;
            }
            
            await saveData();
            closeInteractionModal();
            renderCRMContacts();
            showToast('Interaction added!', 'success');
        });

        // ==================== ANALYTICS FUNCTIONS ====================
        
        function renderAnalytics() {
            const tenders = database.tenders || [];
            
            // Win rate stats
            const priced = tenders.filter(t => t.status === 'PRICED' || t.status === 'AWARDED' || t.status === 'NOT_WON');
            const won = tenders.filter(t => t.status === 'AWARDED');
            const lost = tenders.filter(t => t.status === 'NOT_WON');
            const winRate = priced.length > 0 ? ((won.length / priced.length) * 100).toFixed(1) : 0;
            
            document.getElementById('analyticsTotalPriced').textContent = priced.length;
            document.getElementById('analyticsWon').textContent = won.length;
            document.getElementById('analyticsLost').textContent = lost.length;
            document.getElementById('analyticsWinRate').textContent = winRate + '%';
            
            // Pipeline values
            const toPriceValue = sumValues(tenders.filter(t => t.status === 'TO_PRICE'));
            const pricedValue = sumValues(tenders.filter(t => t.status === 'PRICED'));
            const awardedValue = sumValues(tenders.filter(t => t.status === 'AWARDED'));
            const totalPipeline = toPriceValue + pricedValue + awardedValue;
            
            document.getElementById('analyticsToPriceValue').textContent = formatCurrency(toPriceValue);
            document.getElementById('analyticsPricedValue').textContent = formatCurrency(pricedValue);
            document.getElementById('analyticsAwardedValue').textContent = formatCurrency(awardedValue);
            document.getElementById('analyticsTotalPipeline').textContent = formatCurrency(totalPipeline);
            
            // Region performance
            const regionStats = {};
            tenders.forEach(t => {
                if (!regionStats[t.regionId]) {
                    regionStats[t.regionId] = { total: 0, won: 0, value: 0 };
                }
                regionStats[t.regionId].total++;
                if (t.status === 'AWARDED') {
                    regionStats[t.regionId].won++;
                    regionStats[t.regionId].value += parseFloat(t.awardedValue?.replace(/[^0-9.]/g, '')) || 0;
                }
            });
            
            const sortedRegions = Object.entries(regionStats)
                .sort((a, b) => b[1].value - a[1].value)
                .slice(0, 10);
            
            document.getElementById('regionPerformanceList').innerHTML = sortedRegions.map(([regionId, stats]) => {
                const region = qldRegions.find(r => r.id === regionId);
                const winRate = stats.total > 0 ? ((stats.won / stats.total) * 100).toFixed(0) : 0;
                return `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-[#771414] bg-opacity-10 text-[#771414] flex items-center justify-center font-bold">
                            ${winRate}%
                        </div>
                        <div>
                            <div class="font-semibold text-gray-900">${region?.name}</div>
                            <div class="text-sm text-gray-500">${stats.won}/${stats.total} won</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-gray-900">${formatCurrency(stats.value)}</div>
                        <div class="text-sm text-gray-500">awarded</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // ==================== UTILITY FUNCTIONS ====================
        
        async function saveData() {
            if (isDemoMode) {
                try {
                    localStorage.setItem('qldBusinessData_demo_v2', JSON.stringify(database));
                } catch (e) {
                    showToast('Error saving: Storage may be full', 'error');
                }
            } else if (db && currentUser) {
                try {
                    await db.collection('users').doc(currentUser.uid).set(database);
                } catch (err) {
                    showToast('Error saving: ' + err.message, 'error');
                    throw err;
                }
            }
        }

        function updateAllStats() {
            // Tender stats
            const toPrice = database.tenders.filter(t => t.status === 'TO_PRICE').length;
            const priced = database.tenders.filter(t => t.status === 'PRICED').length;
            const notPricing = database.tenders.filter(t => t.status === 'NOT_PRICING').length;
            const awarded = database.tenders.filter(t => t.status === 'AWARDED').length;
            const notWon = database.tenders.filter(t => t.status === 'NOT_WON').length;
            
            document.getElementById('statToPrice').textContent = toPrice;
            document.getElementById('statPriced').textContent = priced;
            document.getElementById('statNotPricing').textContent = notPricing;
            document.getElementById('statAwarded').textContent = awarded;
            document.getElementById('statNotWon').textContent = notWon;
            
            const totalAwarded = database.tenders
                .filter(t => t.status === 'AWARDED')
                .reduce((sum, t) => sum + (parseFloat(t.awardedValue?.replace(/[^0-9.]/g, '')) || 0), 0);
            document.getElementById('statTotalValue').textContent = formatCurrency(totalAwarded);
            
            // CRM stats
            updateCRMStats();
        }

        function updateCRMStats() {
            const contacts = database.crmContacts || [];
            const interactions = database.interactions || [];
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const recentInteractions = interactions.filter(i => new Date(i.date) >= thirtyDaysAgo).length;
            const followupsDue = contacts.filter(c => c.followUpDate && new Date(c.followUpDate) <= new Date()).length;
            
            document.getElementById('crmTotalContacts').textContent = contacts.length;
            document.getElementById('crmActiveContacts').textContent = contacts.filter(c => c.lastContactDate && new Date(c.lastContactDate) >= thirtyDaysAgo).length;
            document.getElementById('crmRecentInteractions').textContent = recentInteractions;
            document.getElementById('crmFollowups').textContent = followupsDue;
        }

        function sumValues(tenders) {
            return tenders.reduce((sum, t) => {
                const val = parseFloat(t.value?.replace(/[^0-9.]/g, '')) || 0;
                return sum + val;
            }, 0);
        }

        function formatCurrency(value) {
            if (value >= 1000000) {
                return '$' + (value / 1000000).toFixed(1) + 'M';
            } else if (value >= 1000) {
                return '$' + (value / 1000).toFixed(0) + 'K';
            }
            return '$' + value;
        }

        function updateSyncStatus(status) {
            const indicator = document.getElementById('syncStatus');
            if (status === 'Synced' || status === 'Demo Mode') {
                indicator.innerHTML = `<i class="fas ${isDemoMode ? 'fa-flask' : 'fa-check-circle'} mr-1"></i> ${status}`;
                indicator.className = isDemoMode ? 'flex items-center text-amber-600' : 'flex items-center text-green-600';
            } else if (status === 'Offline') {
                indicator.innerHTML = '<i class="fas fa-wifi-slash mr-1"></i> Offline';
                indicator.className = 'flex items-center text-orange-600';
            } else {
                indicator.innerHTML = '<i class="fas fa-sync-alt mr-1 fa-spin"></i> Syncing...';
                indicator.className = 'flex items-center text-blue-600';
            }
        }

        function globalSearch() {
            const query = document.getElementById('globalSearch').value.toLowerCase();
            if (!query) {
                if (currentMainTab === 'tenders') loadRegion(currentRegion);
                else if (currentMainTab === 'crm') renderCRMContacts();
                return;
            }
            
            // Search across tenders
            const filteredTenders = database.tenders.filter(t => 
                t.title.toLowerCase().includes(query) || 
                t.category.toLowerCase().includes(query) ||
                t.contact?.name.toLowerCase().includes(query)
            );
            
            if (currentMainTab === 'tenders') {
                document.getElementById('regionContent').innerHTML = `
                    <div class="glass-panel rounded-2xl p-6 mb-6">
                        <h2 class="text-xl font-bold display-font mb-4">Search Results: "${query}"</h2>
                        <p class="text-gray-600 mb-4">Found ${filteredTenders.length} tenders</p>
                        <button onclick="loadRegion('${currentRegion}')" class="text-[#771414] hover:underline mb-4">
                            <i class="fas fa-arrow-left mr-1"></i> Back to region view
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${filteredTenders.map(tender => {
                            const region = qldRegions.find(r => r.id === tender.regionId);
                            return `
                            <div class="bg-white rounded-xl p-5 shadow-sm card-hover cursor-pointer" onclick="loadRegion('${tender.regionId}'); setTimeout(() => editTender(${tender.id}), 100)">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-xs font-semibold px-2 py-1 rounded bg-[#771414] bg-opacity-10 text-[#771414]">${region?.name}</span>
                                    <span class="text-xs font-semibold px-2 py-1 rounded bg-gray-100 text-gray-600">${tender.status}</span>
                                </div>
                                <h4 class="font-bold text-gray-900 mb-2">${tender.title}</h4>
                                <div class="text-sm text-gray-600">${tender.value}</div>
                            </div>`;
                        }).join('')}
                    </div>
                `;
            }
        }

        function exportToExcel() {
            let csv = 'Type,Region,Title,Category,Status,Value,Closing Date,Contact Name,Contact Email,Contact Phone,Description\n';
            
            database.tenders.forEach(t => {
                const region = qldRegions.find(r => r.id === t.regionId);
                csv += `Tender,${region?.name},"${t.title}","${t.category}","${t.status}","${t.value}","${t.closingDate}","${t.contact?.name}","${t.contact?.email}","${t.contact?.phone}","${t.description}"\n`;
            });
            
            if (database.crmContacts) {
                database.crmContacts.forEach(c => {
                    const region = qldRegions.find(r => r.id === c.regionId);
                    csv += `Contact,${region?.name},"${c.name}","${c.type}","${c.position}","${c.department}","${c.email}","${c.directPhone}","${c.mobile}","${c.notes}"\n`;
                });
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `QLD_Business_CRM_Report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showToast('Report exported successfully!', 'success');
        }

        function shareReport() {
            const shareData = {
                title: 'QLD Business Development & CRM Report',
                text: `Managing ${database.tenders.length} tenders and ${database.crmContacts?.length || 0} contacts across 77 Queensland LGAs`,
                url: window.location.href
            };
            
            if (navigator.share) {
                navigator.share(shareData);
            } else {
                navigator.clipboard.writeText(window.location.href);
                showToast('Link copied to clipboard!', 'success');
            }
        }

        function quickAdd() {
            if (currentMainTab === 'tenders') {
                showAddTenderModal();
            } else if (currentMainTab === 'crm') {
                showAddCRMModal();
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-amber-500'
            };
            
            toast.className = `toast ${colors[type] || colors.info} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2`;
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // Close modals on outside click
        document.getElementById('tenderModal').addEventListener('click', function(e) {
            if (e.target === this) closeTenderModal();
        });
        document.getElementById('crmModal').addEventListener('click', function(e) {
            if (e.target === this) closeCRMModal();
        });
        document.getElementById('interactionModal').addEventListener('click', function(e) {
            if (e.target === this) closeInteractionModal();
        });

        // ==================== ADMIN FUNCTIONS ====================

        async function showAdminPanel() {
            if (!await checkIfAdmin()) {
                showToast('Access denied. Admin only.', 'error');
                return;
            }
            
            document.getElementById('adminPanel').classList.remove('hidden');
            loadPendingApprovals();
            loadApprovedUsers();
        }

        function closeAdminPanel() {
            document.getElementById('adminPanel').classList.add('hidden');
        }

        async function loadPendingApprovals() {
            try {
                const snapshot = await db.collection('approvalRequests')
                    .where('status', '==', 'pending')
                    .orderBy('requestedAt', 'desc')
                    .get();
                
                const container = document.getElementById('pendingApprovalsList');
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-400 bg-gray-50 rounded-lg">
                            <i class="fas fa-check-circle text-3xl mb-2 text-green-500"></i>
                            <p>No pending approval requests</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const date = new Date(data.requestedAt).toLocaleDateString('en-AU');
                    return `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <div class="font-semibold text-gray-900">${data.email}</div>
                            <div class="text-sm text-gray-500">Requested: ${date}</div>
                            <div class="text-xs text-gray-400 mt-1">UID: ${data.uid}</div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="approveUser('${data.uid}', '${data.email}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium">
                                <i class="fas fa-check mr-1"></i> Approve
                            </button>
                            <button onclick="rejectUser('${data.uid}')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm font-medium">
                                <i class="fas fa-times mr-1"></i> Reject
                            </button>
                        </div>
                    </div>
                    `;
                }).join('');
                
            } catch (err) {
                console.error("Error loading approvals:", err);
                document.getElementById('pendingApprovalsList').innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                        <p>Error loading requests. Check permissions.</p>
                    </div>
                `;
            }
        }

        async function loadApprovedUsers() {
            try {
                const snapshot = await db.collection('approvedUsers')
                    .where('approved', '==', true)
                    .orderBy('approvedAt', 'desc')
                    .get();
                
                const container = document.getElementById('approvedUsersList');
                
                if (snapshot.empty) {
                    container.innerHTML = '<p class="text-gray-400 text-center py-4">No approved users yet</p>';
                    return;
                }
                
                container.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const date = data.approvedAt ? new Date(data.approvedAt).toLocaleDateString('en-AU') : 'Unknown';
                    return `
                    <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-100">
                        <div>
                            <div class="font-medium text-gray-900">${data.email}</div>
                            <div class="text-xs text-green-700">Approved: ${date}</div>
                        </div>
                        <button onclick="revokeAccess('${doc.id}')" class="text-red-600 hover:text-red-800 text-sm">
                            <i class="fas fa-user-times"></i> Revoke
                        </button>
                    </div>
                    `;
                }).join('');
                
            } catch (err) {
                console.error("Error loading approved users:", err);
            }
        }

        async function approveUser(uid, email) {
            try {
                // Add to approved users
                await db.collection('approvedUsers').doc(uid).set({
                    email: email,
                    approved: true,
                    approvedAt: new Date().toISOString(),
                    approvedBy: currentUser.email
                });
                
                // Update request status
                await db.collection('approvalRequests').doc(uid).update({
                    status: 'approved',
                    approvedAt: new Date().toISOString()
                });
                
                showToast(`Approved ${email}`, 'success');
                loadPendingApprovals();
                loadApprovedUsers();
                
            } catch (err) {
                showToast('Error approving user: ' + err.message, 'error');
            }
        }

        async function rejectUser(uid) {
            if (!confirm('Are you sure you want to reject this user? They will not be able to access the system.')) {
                return;
            }
            
            try {
                await db.collection('approvalRequests').doc(uid).update({
                    status: 'rejected',
                    rejectedAt: new Date().toISOString()
                });
                
                showToast('User rejected', 'info');
                loadPendingApprovals();
                
            } catch (err) {
                showToast('Error rejecting user: ' + err.message, 'error');
            }
        }

        async function revokeAccess(uid) {
            if (!confirm('Are you sure you want to revoke this user\'s access?')) {
                return;
            }
            
            try {
                await db.collection('approvedUsers').doc(uid).update({
                    approved: false,
                    revokedAt: new Date().toISOString(),
                    revokedBy: currentUser.email
                });
                
                showToast('Access revoked', 'success');
                loadApprovedUsers();
                
            } catch (err) {
                showToast('Error revoking access: ' + err.message, 'error');
            }
        }
    </script>
</body>
</html>